#include <stdlib.h>
#include <stdio.h>


void print_banner(){
    puts("┬ ┬┌─┐┌─┐┌─┐┌─┐┬ ┬┬─┐┬┌┬┐┬ ┬  ┬ ┬┌─┐┬ ┬┌─┐┌─┐  ┌─┐┌─┐  ┌─┐┌─┐┬─┐┌─┐┌─┐");
    puts("│ │├─┘└─┐├┤ │  │ │├┬┘│ │ └┬┘  ├─┤│ ││ │└─┐├┤   │ │├┤   ├┤ │ │├┬┘│  ├┤ ");
    puts("└─┘┴  └─┘└─┘└─┘└─┘┴└─┴ ┴  ┴   ┴ ┴└─┘└─┘└─┘└─┘  └─┘└    └  └─┘┴└─└─┘└─┘");    
    puts("");
}

void print_menu(int malloc_request_count){
    printf("1) malloc %d/4\n",malloc_request_count);
    puts("2) target");
    puts("3) quit");
}
ulong read_num(){
    char input[32];
    read(0,input,31);
    return strtoul(input,0,0);
}
// The write target.
char target[32] = "XXXXXXX";

int main(int argc, char* argv[]) {
    // Disable stdout buffering.
    setbuf(stdout, NULL);
    // the malloc request array.
    char * malloc_array[4];

    ulong malloc_request_index = 0;
    ulong size;
    ulong menu_option;
    // Print the challenge banner.
    print_banner();

    // Leak the puts address.
    printf("puts() @ %p\n", puts);
    
    // Leak the heap address.
    void* chunk_a = malloc(0x88);
    printf("heap @ %p\n", chunk_a -0x10);
    free(chunk_a);
   
    while(1) {
        
        printf("\n1) malloc %d/4\n",malloc_request_index);
        puts("2) target");
        puts("3) quit");
        printf("> ");
        menu_option = read_num();
        // Malloc  
        if (menu_option == 1) {

            if (malloc_request_index >= 4) {
                puts("maximum requests reached");   
                continue;
            }
            // Get the size.
            printf("size: ");
            size = read_num();
            // allocate memory
            malloc_array[malloc_request_index] = malloc(size);
            // if it returns 0 malloc could not allocate a chunk.
            if (malloc_array[malloc_request_index] == 0) {
                puts("request failed");
                continue;
            }
            // Get & write the data
            printf("data: ");
            long read_size = malloc_usable_size(malloc_array[malloc_request_index]);
            read(0,malloc_array[malloc_request_index],read_size+8);

            // increment the request count.
            malloc_request_index = malloc_request_index + 1;

        }
        // Print the target variable.
        if (menu_option == 2) {
            printf("\ntarget: %s\n",target);
        }
        // Exit the program
        if (menu_option == 3){
            exit(0);
        }
    }
	return 0;
}
